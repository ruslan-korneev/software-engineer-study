# Структура командной строки (Prompt Structure)

## Что такое Prompt?

**Prompt** (приглашение командной строки) — это текст, который shell показывает перед каждой командой. Он сообщает пользователю информацию о системе и готовности принимать ввод.

```bash
username@hostname:~/projects$
|________|________|_________|_|
    |        |         |     |
   USER     HOST     PWD  символ prompt
```

## Переменная PS1

В Bash prompt определяется переменной `PS1` (Prompt String 1):

```bash
# Посмотреть текущий prompt
echo $PS1
# \u@\h:\w\$

# Установить простой prompt
PS1="$ "
# $

# Вернуть стандартный
PS1="\u@\h:\w\$ "
# username@hostname:~/projects$
```

## Escape-последовательности Bash

Специальные последовательности, начинающиеся с `\`, подставляют динамическую информацию:

### Информация о пользователе и системе

| Sequence | Описание | Пример |
|----------|----------|--------|
| `\u` | имя пользователя | `username` |
| `\h` | имя хоста (до первой точки) | `mycomputer` |
| `\H` | полное имя хоста | `mycomputer.local` |
| `\s` | имя оболочки | `bash` |
| `\v` | версия bash (короткая) | `5.1` |
| `\V` | версия bash (полная) | `5.1.8` |

### Информация о директории

| Sequence | Описание | Пример |
|----------|----------|--------|
| `\w` | текущая директория (с ~) | `~/projects/app` |
| `\W` | только имя директории | `app` |
| `\$` | `$` для обычного пользователя, `#` для root | `$` |

### Дата и время

| Sequence | Описание | Пример |
|----------|----------|--------|
| `\d` | дата (день недели месяц число) | `Mon Dec 25` |
| `\t` | время 24-часовой формат HH:MM:SS | `14:30:45` |
| `\T` | время 12-часовой формат HH:MM:SS | `02:30:45` |
| `\@` | время 12-часовой формат с AM/PM | `02:30 PM` |
| `\A` | время 24-часовой формат HH:MM | `14:30` |

### Служебные

| Sequence | Описание |
|----------|----------|
| `\n` | новая строка |
| `\r` | возврат каретки |
| `\\` | обратный слеш |
| `\[` | начало невидимых символов (для цветов) |
| `\]` | конец невидимых символов |
| `\!` | номер команды в истории |
| `\#` | номер команды в текущей сессии |
| `\j` | количество фоновых задач |

## Примеры промптов

### Минимальный

```bash
PS1='$ '
# $
```

### Стандартный (Ubuntu-style)

```bash
PS1='\u@\h:\w\$ '
# username@hostname:~/projects$
```

### С временем

```bash
PS1='[\t] \u@\h:\w\$ '
# [14:30:45] username@hostname:~/projects$
```

### Двухстрочный

```bash
PS1='\u@\h:\w\n\$ '
# username@hostname:~/projects
# $
```

### Информативный двухстрочный

```bash
PS1='[\d \t] \u@\h:\w\n\$ '
# [Mon Dec 25 14:30:45] username@hostname:~/projects
# $
```

### С номером команды в истории

```bash
PS1='[\!] \u:\W\$ '
# [1042] username:projects$
```

### Только директория

```bash
PS1='\W \$ '
# projects $
```

## Другие переменные Prompt

### PS2 — продолжение команды

Показывается, когда команда не завершена:

```bash
PS2='> '

# Пример использования:
echo "This is a
> very long
> string"
```

```bash
# Установить другой PS2
PS2='... '

echo "This is a
... very long
... string"
```

### PS3 — для select в скриптах

```bash
PS3='Выберите вариант: '

select opt in "Option 1" "Option 2" "Quit"; do
    case $opt in
        "Option 1") echo "Вы выбрали 1";;
        "Option 2") echo "Вы выбрали 2";;
        "Quit") break;;
    esac
done

# Вывод:
# 1) Option 1
# 2) Option 2
# 3) Quit
# Выберите вариант:
```

### PS4 — для отладки (set -x)

```bash
PS4='+ ${BASH_SOURCE}:${LINENO}: '

set -x
echo "test"
# + script.sh:5: echo test
# test
```

## Динамический Prompt

### С помощью команд

Можно включать вывод команд через `$()` или обратные кавычки:

```bash
# Показать ветку git (простой вариант)
PS1='\u@\h:\w $(git branch 2>/dev/null | grep "*" | cut -d" " -f2)\$ '
# username@hostname:~/projects main$

# Показать количество файлов
PS1='\u:\W ($(ls | wc -l) files)\$ '
# username:projects (42 files)$
```

### С помощью PROMPT_COMMAND

`PROMPT_COMMAND` выполняется перед каждым показом prompt:

```bash
# Обновлять заголовок терминала
PROMPT_COMMAND='echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD}\007"'

# Записывать историю после каждой команды
PROMPT_COMMAND='history -a'

# Несколько команд
PROMPT_COMMAND='history -a; echo'
```

## Prompt в Zsh

В Zsh синтаксис отличается:

```bash
# Zsh использует % вместо \
# И переменную PROMPT вместо PS1 (хотя PS1 тоже работает)

PROMPT='%n@%m:%~%# '
# username@hostname:~/projects%

# Escape-последовательности Zsh:
# %n — имя пользователя
# %m — имя хоста
# %~ — директория с ~
# %d — полный путь
# %# — % для обычного, # для root
# %D — дата
# %T — время
```

## Практические примеры

### Git-aware prompt (простой)

```bash
parse_git_branch() {
    git branch 2>/dev/null | sed -n 's/* \(.*\)/(\1)/p'
}

PS1='\u@\h:\w $(parse_git_branch)\$ '
# username@hostname:~/projects (main)$
```

### Prompt с кодом возврата предыдущей команды

```bash
PS1='[$?] \u@\h:\w\$ '
# [0] username@hostname:~/projects$  (успех)
# [1] username@hostname:~/projects$  (ошибка)
```

### Prompt с количеством фоновых задач

```bash
PS1='\u@\h:\w [\j jobs]\$ '
# username@hostname:~/projects [2 jobs]$
```

### Минималистичный prompt для демонстраций

```bash
PS1='$ '
# $
```

## Отладка prompt

```bash
# Если prompt сломан, сбросить к простому
PS1='$ '

# Проверить escape-последовательности
echo "PS1 = $PS1"

# Временно установить для теста
PS1='test> '
# Если работает — проблема в escape-последовательностях

# Проблема с длиной строки? Проверить \[ и \]
# Все escape-коды цветов должны быть внутри \[ и \]
```

## Резюме

- `PS1` — основная переменная для настройки prompt
- Escape-последовательности (`\u`, `\h`, `\w`, etc.) добавляют динамическую информацию
- `\[` и `\]` обязательны для непечатаемых символов (цвета)
- `PROMPT_COMMAND` выполняется перед каждым показом prompt
- Zsh использует другой синтаксис (`%n`, `%m`, etc.)

Основные escape-последовательности:
- `\u` — пользователь
- `\h` — хост
- `\w` — директория
- `\$` — символ prompt ($ или #)
- `\t` — время
