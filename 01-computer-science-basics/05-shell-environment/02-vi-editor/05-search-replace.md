# Поиск и замена в Vi (Search and Replace)

## Базовый поиск

### Поиск вперёд

```bash
/pattern    # искать "pattern" вперёд
```

После ввода паттерна нажмите Enter. Vi переместит курсор на первое совпадение.

### Поиск назад

```bash
?pattern    # искать "pattern" назад
```

### Навигация по результатам

```bash
n           # следующее совпадение (в направлении поиска)
N           # предыдущее совпадение (в обратном направлении)
```

**Пример:**

```bash
/function   # найти "function"
n           # следующий "function"
n           # ещё следующий
N           # вернуться к предыдущему
```

### Поиск слова под курсором

```bash
*           # искать слово под курсором вперёд
#           # искать слово под курсором назад
g*          # частичное совпадение вперёд
g#          # частичное совпадение назад
```

**Разница между `*` и `g*`:**

```
Текст: error, errors, error_log
       ^
Курсор на "error"

*   найдёт только "error" (целое слово)
g*  найдёт "error", "errors", "error_log"
```

## Регулярные выражения в поиске

Vi поддерживает регулярные выражения:

```bash
/^function      # строки, начинающиеся с "function"
/;$             # строки, заканчивающиеся на ";"
/\d\+           # одна или более цифр
/\<word\>       # целое слово "word"
/error\|warning # "error" или "warning"
/\v(error|warn) # "very magic" режим (больше похож на стандартный regex)
```

### Специальные символы

| Символ | Значение |
|--------|----------|
| `.` | любой символ |
| `*` | 0 или более предыдущего |
| `\+` | 1 или более предыдущего |
| `\?` | 0 или 1 предыдущего |
| `^` | начало строки |
| `$` | конец строки |
| `\<` | начало слова |
| `\>` | конец слова |
| `[abc]` | любой из символов a, b, c |
| `[^abc]` | любой символ кроме a, b, c |
| `\d` | цифра [0-9] |
| `\s` | пробельный символ |
| `\w` | буква, цифра или _ |

**Примеры:**

```bash
# Найти пустые строки
/^$

# Найти строки с пробелами в конце
/\s\+$

# Найти TODO или FIXME
/TODO\|FIXME

# Найти числа
/\d\+

# Найти email (упрощённо)
/\w\+@\w\+\.\w\+
```

## Настройки поиска

```bash
:set hlsearch      # подсветка всех совпадений (highlight search)
:set nohlsearch    # выключить подсветку
:noh               # временно убрать подсветку (до следующего поиска)

:set incsearch     # показывать совпадения по мере ввода
:set ignorecase    # игнорировать регистр
:set smartcase     # умный регистр (если есть заглавные — учитывать)
```

**Smart case пример:**

```bash
:set ignorecase smartcase
/error      # найдёт "error", "Error", "ERROR"
/Error      # найдёт только "Error" (есть заглавная)
```

### Регистронезависимый поиск для одного запроса

```bash
/pattern\c     # игнорировать регистр
/pattern\C     # учитывать регистр
```

## Базовая замена

### Синтаксис команды замены

```bash
:s/old/new/         # заменить первое вхождение в текущей строке
:s/old/new/g        # заменить все вхождения в текущей строке
:%s/old/new/g       # заменить все вхождения во всём файле
```

### Разбор синтаксиса

```
:[range]s/pattern/replacement/[flags]

range     — диапазон строк
s         — команда substitute
pattern   — что искать
replacement — на что заменять
flags     — модификаторы
```

## Диапазоны (range)

```bash
:s/...        # текущая строка
:5s/...       # строка 5
:5,10s/...    # строки с 5 по 10
:.,$s/...     # от текущей до конца (. = текущая, $ = последняя)
:1,.s/...     # от начала до текущей
:%s/...       # весь файл (% = 1,$)
:'<,'>s/...   # выделенный текст (visual mode)
```

**Специальные символы диапазона:**

| Символ | Значение |
|--------|----------|
| `.` | текущая строка |
| `$` | последняя строка |
| `%` | весь файл |
| `'<` | начало выделения |
| `'>` | конец выделения |
| `+n` | n строк вниз |
| `-n` | n строк вверх |

## Флаги замены

```bash
g     # глобально (все вхождения в строке)
c     # с подтверждением каждой замены
i     # игнорировать регистр
I     # учитывать регистр
n     # только подсчитать (не заменять)
e     # не показывать ошибку если не найдено
```

**Пример с подтверждением:**

```bash
:%s/old/new/gc
```

При каждом совпадении появится запрос:
```
replace with new (y/n/a/q/l/^E/^Y)?
y — заменить
n — пропустить
a — заменить все оставшиеся
q — выйти
l — заменить и выйти (last)
```

## Практические примеры замены

### Простые замены

```bash
# Заменить "foo" на "bar" везде
:%s/foo/bar/g

# Удалить все пробелы в конце строк
:%s/\s\+$//g

# Удалить пустые строки
:g/^$/d

# Добавить ; в конец каждой строки
:%s/$/;/

# Заменить табы на пробелы
:%s/\t/    /g
```

### Использование специальных символов

```bash
# Заменить / на \
:%s/\//\\/g

# Или использовать другой разделитель
:%s#/#\\#g
:%s|/|\\|g
```

### Использование захваченных групп

```bash
# Поменять местами два слова
:%s/\(\w\+\) \(\w\+\)/\2 \1/g
# Или в "very magic" режиме
:%s/\v(\w+) (\w+)/\2 \1/g

# Обернуть числа в скобки
:%s/\(\d\+\)/(\1)/g

# Добавить кавычки к значениям атрибутов
:%s/=\(\w\+\)/="\1"/g
```

### Регистр в замене

```bash
# Замена с сохранением регистра первой буквы
:%s/\<\(f\)oo/\1oobar/g   # foo → foobar, Foo → Foobar

# Преобразование регистра
\u      # следующий символ в верхний регистр
\U      # всё до \e в верхний регистр
\l      # следующий символ в нижний регистр
\L      # всё до \e в нижний регистр
\e      # конец преобразования

# Пример: первую букву в верхний регистр
:%s/\<\(\w\)\(\w\+\)/\u\1\2/g
```

## Команда global

Команда `:g` выполняет действие на строках, соответствующих паттерну:

```bash
:g/pattern/command

# Примеры:
:g/TODO/d           # удалить все строки с TODO
:g/^$/d             # удалить пустые строки
:g/error/p          # напечатать строки с "error"
:g!/pattern/d       # удалить строки БЕЗ pattern (или :v/pattern/d)

# Сложные примеры
:g/function/normal A;     # добавить ; в конец строк с "function"
:g/^#/m$                  # переместить комментарии в конец файла
```

## История поиска

```bash
/       # открыть строку поиска
↑ ↓     # навигация по истории поиска

q/      # открыть окно истории поиска (редактируемое)
q?      # то же для обратного поиска
```

## Полезные команды

### Подсчёт совпадений

```bash
:%s/pattern//gn
# Результат: 42 matches on 15 lines
```

### Поиск и выполнение команды

```bash
# Удалить строки с "debug"
:g/debug/d

# Копировать строки с "error" в конец файла
:g/error/t$

# Выполнить normal-команду на совпадениях
:g/TODO/normal 0i//
# Закомментирует все строки с TODO
```

### Отмена всех замен

```bash
u       # отменить последнюю замену
:u 10   # отменить 10 действий
```

## Резюме

| Действие | Команда |
|----------|---------|
| Поиск вперёд | /pattern |
| Поиск назад | ?pattern |
| Следующее совпадение | n |
| Предыдущее совпадение | N |
| Слово под курсором | * или # |
| Замена в строке | :s/old/new/ |
| Замена во всём файле | :%s/old/new/g |
| С подтверждением | :%s/old/new/gc |
| Команда на совпадениях | :g/pattern/command |

- Используйте `\c` и `\C` для управления регистром в поиске
- `%` в диапазоне означает весь файл
- Флаг `g` нужен для замены всех вхождений в строке
- Флаг `c` позволяет подтверждать каждую замену
- `:g/pattern/d` — удаление строк с паттерном
