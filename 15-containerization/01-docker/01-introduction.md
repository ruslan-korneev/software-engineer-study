# Введение в Docker

## Что такое Docker и контейнеризация

**Docker** — это платформа для разработки, доставки и запуска приложений в изолированных средах, называемых **контейнерами**. Контейнер — это легковесная, переносимая и самодостаточная единица программного обеспечения, которая включает в себя всё необходимое для работы приложения: код, runtime, системные инструменты, библиотеки и настройки.

**Контейнеризация** — это метод виртуализации на уровне операционной системы, позволяющий запускать несколько изолированных пользовательских пространств (контейнеров) на одном ядре ОС.

```
┌─────────────────────────────────────────────────────┐
│                    Host OS Kernel                   │
├─────────────────────────────────────────────────────┤
│                    Docker Engine                    │
├───────────────┬───────────────┬────────────────────┤
│  Container 1  │  Container 2  │    Container 3     │
│  ┌─────────┐  │  ┌─────────┐  │    ┌─────────┐     │
│  │   App   │  │  │   App   │  │    │   App   │     │
│  │  Libs   │  │  │  Libs   │  │    │  Libs   │     │
│  └─────────┘  │  └─────────┘  │    └─────────┘     │
└───────────────┴───────────────┴────────────────────┘
```

---

## История появления Docker

- **2008**: Компания dotCloud основана Соломоном Хайксом (Solomon Hykes)
- **2013**: Docker выпущен как open-source проект на PyCon
- **2014**: Docker 1.0 — первый стабильный релиз
- **2015**: Появление Docker Compose и Docker Swarm
- **2017**: Docker переходит на Moby Project как upstream
- **2019**: Docker Enterprise продан Mirantis
- **2020-настоящее время**: Docker Desktop становится основным инструментом для разработчиков

Docker произвёл революцию в мире DevOps, сделав контейнеризацию доступной для широкого круга разработчиков. До Docker контейнеры использовались в основном крупными компаниями (Google, Facebook) с собственными решениями.

---

## Отличие контейнеров от виртуальных машин

### Архитектурное сравнение

```
    Виртуальные машины                     Контейнеры
┌─────────────────────────┐        ┌─────────────────────────┐
│   App A   │   App B     │        │   App A   │   App B     │
├───────────┼─────────────┤        ├───────────┼─────────────┤
│  Guest OS │  Guest OS   │        │  Bins/Libs│  Bins/Libs  │
├───────────┴─────────────┤        ├─────────────────────────┤
│       Hypervisor        │        │      Docker Engine      │
├─────────────────────────┤        ├─────────────────────────┤
│        Host OS          │        │        Host OS          │
├─────────────────────────┤        ├─────────────────────────┤
│      Infrastructure     │        │      Infrastructure     │
└─────────────────────────┘        └─────────────────────────┘
```

### Сравнительная таблица

| Характеристика | Виртуальные машины | Контейнеры (Docker) |
|----------------|-------------------|---------------------|
| **Изоляция** | Полная (отдельная ОС) | На уровне процессов |
| **Размер** | Гигабайты (ГБ) | Мегабайты (МБ) |
| **Время запуска** | Минуты | Секунды/миллисекунды |
| **Производительность** | Overhead от гипервизора | Близка к native |
| **Плотность** | Десятки на сервер | Сотни/тысячи на сервер |
| **Переносимость** | Ограниченная | Высокая |
| **Ресурсы** | Фиксированно выделенные | Динамически разделяемые |
| **Гостевая ОС** | Требуется полная ОС | Разделяет ядро хоста |

### Когда использовать что

**Виртуальные машины лучше для:**
- Запуска разных операционных систем
- Полной изоляции на уровне ядра
- Legacy-приложений, требующих специфичной ОС

**Контейнеры лучше для:**
- Микросервисной архитектуры
- CI/CD пайплайнов
- Быстрого масштабирования
- Воспроизводимых сред разработки

---

## Преимущества использования Docker

### 1. Переносимость (Portability)
```
"Works on my machine" → "Works everywhere"
```
Контейнер работает одинаково на любой машине с Docker: локальный ноутбук, тестовый сервер, production.

### 2. Изоляция
Каждый контейнер имеет свою файловую систему, сеть, процессы. Конфликты между приложениями исключены.

### 3. Эффективность использования ресурсов
- Нет overhead от гипервизора
- Контейнеры разделяют ядро ОС
- Запускаются за секунды

### 4. Версионирование и откаты
Образы Docker имеют версии (теги). Можно легко откатиться к предыдущей версии.

### 5. Масштабируемость
Контейнеры легко реплицировать для обработки повышенной нагрузки.

### 6. Согласованность среды
```
Development = Staging = Production
```

### 7. Инфраструктура как код (IaC)
Dockerfile описывает инфраструктуру в виде кода, который можно версионировать в Git.

### 8. Богатая экосистема
- Docker Hub с тысячами готовых образов
- Docker Compose для multi-container приложений
- Интеграция с Kubernetes, CI/CD системами

---

## Основные концепции Docker

### Images (Образы)

**Docker Image** — это read-only шаблон с инструкциями для создания контейнера. Образ содержит:
- Базовую операционную систему
- Runtime (Node.js, Python, Java и т.д.)
- Код приложения
- Зависимости и библиотеки
- Переменные окружения и конфигурацию

```dockerfile
# Пример Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "app.py"]
```

**Ключевые характеристики образов:**
- Состоят из слоёв (layers)
- Неизменяемы (immutable)
- Могут наследоваться друг от друга
- Идентифицируются по имени и тегу: `python:3.11-slim`

### Containers (Контейнеры)

**Container** — это запущенный экземпляр образа. Это изолированный процесс с собственной файловой системой, сетью и пространством имён процессов.

```bash
# Создание и запуск контейнера из образа
docker run -d --name my-app -p 8080:80 nginx:latest

# Контейнер = Образ + Runtime Environment
```

**Жизненный цикл контейнера:**
1. **Created** — создан, но не запущен
2. **Running** — работает
3. **Paused** — приостановлен
4. **Stopped** — остановлен
5. **Deleted** — удалён

### Registries (Реестры)

**Registry** — это хранилище Docker образов. Аналог GitHub для Docker images.

**Типы реестров:**
- **Docker Hub** — публичный реестр по умолчанию
- **Private Registry** — приватный реестр компании
- **Cloud Registries:**
  - AWS ECR (Elastic Container Registry)
  - Google GCR (Google Container Registry)
  - Azure ACR (Azure Container Registry)
  - GitHub Container Registry (ghcr.io)

```bash
# Push образа в реестр
docker push mycompany/myapp:v1.0

# Pull образа из реестра
docker pull nginx:latest
```

---

## Когда использовать Docker

### Docker подходит для:

1. **Микросервисной архитектуры**
   - Каждый сервис в своём контейнере
   - Независимое развёртывание и масштабирование

2. **CI/CD пайплайнов**
   - Согласованная среда сборки и тестирования
   - Быстрое создание изолированных сред

3. **Разработки**
   - Одинаковая среда для всей команды
   - Быстрый onboarding новых разработчиков

4. **Тестирования**
   - Изолированные тестовые среды
   - Интеграционные тесты с базами данных

5. **Легаси-приложений**
   - Контейнеризация старых приложений
   - Миграция в облако

### Docker НЕ подходит для:

1. **Desktop приложений с GUI** (хотя технически возможно)
2. **Приложений, требующих прямой доступ к железу** (драйверы, GPU без специальной настройки)
3. **Когда нужна полная изоляция на уровне ядра** (используйте VM)
4. **Windows-специфичные приложения на Linux** (и наоборот)

---

## Типичные Use Cases

### 1. Локальная среда разработки

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/app
    depends_on:
      - db
  db:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: secret
```

### 2. CI/CD Pipeline

```yaml
# GitHub Actions пример
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t myapp:${{ github.sha }} .
      - name: Push to registry
        run: docker push myregistry/myapp:${{ github.sha }}
```

### 3. Микросервисная архитектура

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   API GW    │────▶│   Service   │────▶│   Service   │
│  Container  │     │  Container  │     │  Container  │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  Database   │
                    │  Container  │
                    └─────────────┘
```

### 4. Быстрое прототипирование

```bash
# Запуск Redis для тестов за секунды
docker run -d -p 6379:6379 redis:alpine

# Запуск PostgreSQL
docker run -d -p 5432:5432 \
  -e POSTGRES_PASSWORD=password \
  postgres:15

# Запуск Elasticsearch
docker run -d -p 9200:9200 \
  -e "discovery.type=single-node" \
  elasticsearch:8.10.0
```

### 5. Multi-tenant среды

Изоляция клиентов друг от друга с помощью контейнеров.

### 6. Машинное обучение

```dockerfile
# ML окружение с GPU поддержкой
FROM nvidia/cuda:12.0-base
RUN pip install tensorflow pytorch
```

---

## Best Practices

### Для образов

1. **Используйте официальные базовые образы**
   ```dockerfile
   FROM python:3.11-slim  # Официальный образ
   ```

2. **Минимизируйте размер образа**
   - Используйте `-slim` или `-alpine` версии
   - Удаляйте кэш пакетных менеджеров

3. **Один контейнер — один процесс**

4. **Не храните секреты в образах**
   ```dockerfile
   # Плохо
   ENV API_KEY=secret123

   # Хорошо — передавать через runtime
   docker run -e API_KEY=$API_KEY myapp
   ```

### Для контейнеров

1. **Не запускайте от root**
   ```dockerfile
   USER nonroot
   ```

2. **Используйте health checks**
   ```dockerfile
   HEALTHCHECK CMD curl -f http://localhost/health || exit 1
   ```

3. **Логируйте в stdout/stderr**

---

## Полезные команды для начала

```bash
# Проверка версии
docker --version

# Запуск первого контейнера
docker run hello-world

# Список запущенных контейнеров
docker ps

# Список всех контейнеров
docker ps -a

# Список образов
docker images

# Остановка контейнера
docker stop <container_id>

# Удаление контейнера
docker rm <container_id>

# Удаление образа
docker rmi <image_id>
```

---

## Ресурсы для изучения

- [Официальная документация Docker](https://docs.docker.com/)
- [Docker Hub](https://hub.docker.com/)
- [Play with Docker](https://labs.play-with-docker.com/) — онлайн-песочница
- [Docker Curriculum](https://docker-curriculum.com/)
