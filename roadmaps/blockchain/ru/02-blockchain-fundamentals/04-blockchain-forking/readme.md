# Форки блокчейна

## Введение

Форк (fork) — это одно из ключевых понятий в мире блокчейна, которое описывает разделение или изменение протокола сети. Понимание форков критически важно для всех участников криптовалютного пространства: разработчиков, майнеров, инвесторов и обычных пользователей.

---

## 1. Что такое форк

### Определение

**Форк** (от англ. fork — вилка, разветвление) — это изменение правил консенсуса блокчейн-сети, которое может привести к разделению цепи на две или более независимые ветви.

```
Блок 100 → Блок 101 → Блок 102 → Блок 103 (оригинальная цепь)
                              ↘
                               Блок 103' → Блок 104' (форк)
```

### Почему происходят форки

1. **Обновление протокола** — внедрение новых функций или исправление ошибок
2. **Разногласия в сообществе** — несогласие по поводу направления развития
3. **Исправление уязвимостей** — реакция на обнаруженные атаки или взломы
4. **Масштабирование** — увеличение пропускной способности сети
5. **Естественные причины** — временные расхождения при одновременном нахождении блоков

### Временные vs постоянные форки

| Характеристика | Временный форк | Постоянный форк |
|----------------|----------------|-----------------|
| Причина | Одновременное нахождение блоков | Изменение протокола |
| Длительность | Несколько блоков | Навсегда |
| Разрешение | Автоматически по правилу самой длинной цепи | Создание отдельной криптовалюты |
| Пример | Обычная работа сети | Bitcoin Cash, Ethereum Classic |

---

## 2. Soft Fork (мягкий форк)

### Определение

**Soft fork** — это изменение протокола, при котором новые правила являются подмножеством старых правил. Блоки, созданные по новым правилам, принимаются узлами со старым программным обеспечением.

```
Старые правила: блок может быть до 1 МБ
Новые правила: блок может быть до 800 КБ

→ Блок 750 КБ валиден для ВСЕХ узлов
→ Блок 900 КБ валиден только для старых узлов
```

### Обратная совместимость

Soft fork обеспечивает **обратную совместимость**:

- ✅ Старые узлы продолжают работать
- ✅ Новые правила ужесточают существующие
- ✅ Нет разделения сети при достаточной поддержке
- ⚠️ Старые узлы могут не понимать новые транзакции полностью

### Пример: SegWit в Bitcoin

**Segregated Witness (SegWit)** — один из самых известных soft fork'ов Bitcoin (август 2017):

```
До SegWit:
┌─────────────────────────────┐
│ Transaction                 │
│ ├── Inputs                  │
│ │   └── scriptSig (подпись) │
│ ├── Outputs                 │
│ └── Metadata                │
└─────────────────────────────┘

После SegWit:
┌─────────────────────────────┐
│ Transaction                 │
│ ├── Inputs                  │
│ │   └── (пустой scriptSig)  │
│ ├── Outputs                 │
│ └── Metadata                │
└─────────────────────────────┘
        ↓
┌─────────────────────────────┐
│ Witness (отдельная секция)  │
│ └── Подписи                 │
└─────────────────────────────┘
```

**Преимущества SegWit:**
- Увеличение ёмкости блока (до ~2 МБ эффективно)
- Решение проблемы transaction malleability
- Основа для Lightning Network

### Процесс активации Soft Fork

1. **Предложение (BIP)** — публикация Bitcoin Improvement Proposal
2. **Разработка** — написание и тестирование кода
3. **Сигнализация** — майнеры сигнализируют о готовности
4. **Активация** — при достижении порога (обычно 95%)
5. **Период grace** — время на обновление

```
Пример сигнализации:
┌────────────────────────────────────┐
│ Период: 2016 блоков (~2 недели)    │
│ Порог активации: 95% (1916 блоков) │
│                                    │
│ Результат: 1950 блоков сигнализируют│
│ → Soft fork АКТИВИРОВАН            │
└────────────────────────────────────┘
```

---

## 3. Hard Fork (жёсткий форк)

### Определение

**Hard fork** — это несовместимое изменение протокола, при котором новые правила отвергаются узлами со старым программным обеспечением. Это приводит к необратимому разделению сети.

```
Старые правила: блок до 1 МБ
Новые правила: блок до 8 МБ

→ Блок 2 МБ ОТВЕРГАЕТСЯ старыми узлами
→ Блок 2 МБ принимается новыми узлами
→ РАЗДЕЛЕНИЕ СЕТИ
```

### Отсутствие обратной совместимости

Hard fork создаёт **несовместимые цепи**:

- ❌ Старые узлы отвергают новые блоки
- ❌ Новые узлы могут отвергать старые блоки
- ⚠️ Сеть разделяется на две независимые
- ⚠️ Каждая цепь имеет свою криптовалюту

### Разделение цепи

```
                          Hard Fork (блок 478558)
                                   ↓
     ┌─────────────────────────────┼─────────────────────────────┐
     │                             │                             │
     ▼                             │                             ▼
Bitcoin (BTC)                      │                     Bitcoin Cash (BCH)
├── Блок 1 МБ                      │                     ├── Блок 8 МБ
├── SegWit                         │                     ├── Без SegWit
└── Lightning Network              │                     └── On-chain масштабирование
                                   │
                        До форка: общая история
```

---

## 4. Известные форки

### Bitcoin Cash (BCH) — история и причины

**Дата:** 1 августа 2017 года (блок 478558)

**Причины разделения:**
1. Дебаты о масштабировании Bitcoin
2. Разногласия по поводу SegWit
3. Разное видение: "цифровое золото" vs "электронные деньги"

```
Bitcoin (BTC)              Bitcoin Cash (BCH)
──────────────────────────────────────────────
Блок: 1 МБ (+ SegWit)      Блок: 8 МБ → 32 МБ
Философия: Store of Value   Философия: Medium of Exchange
Layer 2: Lightning          Layer 1: On-chain scaling
Сложность: DAA              Сложность: EDA → DAA
```

**Последствия:**
- Все держатели BTC получили равное количество BCH
- Две конкурирующие криптовалюты
- Дальнейшее разделение сообщества

### Ethereum Classic (ETC) — взлом DAO

**Дата:** 20 июля 2016 года (блок 1920000)

**Предыстория:**
- The DAO — децентрализованная автономная организация
- Собрано ~$150 млн в ETH
- Хакер обнаружил уязвимость и вывел ~$50 млн

```
Проблема:
┌───────────────────────────────────────┐
│ DAO Contract                          │
│ function withdraw() {                 │
│   msg.sender.call.value(balance)();   │  ← Reentrancy атака
│   balance[msg.sender] = 0;            │  ← Обнуление ПОСЛЕ отправки
│ }                                     │
└───────────────────────────────────────┘

Атака:
Хакер → withdraw() → получение ETH →
      → повторный вызов withdraw() →
      → получение ETH → ... (рекурсия)
```

**Решение:**
- **Сторонники hard fork:** откат транзакций (возврат средств)
- **Противники:** "код — это закон" (immutability)

```
                      Блок 1920000
                           ↓
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
      Ethereum (ETH)            Ethereum Classic (ETC)
      Hard fork                 Оригинальная цепь
      Средства возвращены       "Code is law"
```

### Bitcoin SV (BSV)

**Дата:** 15 ноября 2018 года

**Причина:** Разногласия внутри Bitcoin Cash

```
Bitcoin → Bitcoin Cash → Bitcoin SV
                ↓
         Bitcoin Cash ABC

BSV позиция:
- Блоки до 128 МБ (затем без ограничений)
- "Satoshi's Vision" — возврат к оригинальному протоколу
- Лидер: Craig Wright
```

### Другие примеры

| Форк | Родитель | Тип | Причина |
|------|----------|-----|---------|
| Litecoin (LTC) | Bitcoin | Code fork | Другой алгоритм, быстрые блоки |
| Monero (XMR) | Bytecoin | Hard fork | Справедливый запуск |
| Ethereum PoS | Ethereum PoW | Hard fork | Переход на Proof of Stake |

---

## 5. Управление форками

### Governance в блокчейне

**Governance** — система принятия решений о развитии протокола.

```
┌─────────────────────────────────────────────────────┐
│                GOVERNANCE МОДЕЛИ                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Off-chain Governance (Bitcoin, Ethereum)           │
│  ├── Обсуждения в сообществе                        │
│  ├── BIP/EIP предложения                            │
│  ├── Майнеры сигнализируют                          │
│  └── Core developers принимают решения              │
│                                                     │
│  On-chain Governance (Tezos, Polkadot)              │
│  ├── Голосование токенами                           │
│  ├── Автоматическая активация                       │
│  └── Формализованный процесс                        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### BIP, EIP — предложения по улучшению

**BIP (Bitcoin Improvement Proposal):**
```
BIP-0001: Формат BIP
BIP-0032: Hierarchical Deterministic Wallets
BIP-0039: Mnemonic seed phrases
BIP-0141: SegWit
BIP-0340: Schnorr Signatures
BIP-0341: Taproot
```

**EIP (Ethereum Improvement Proposal):**
```
EIP-20: Token Standard (ERC-20)
EIP-721: NFT Standard (ERC-721)
EIP-1559: Fee Market Change
EIP-4844: Proto-Danksharding
```

**Структура предложения:**
```markdown
# EIP-XXXX: Название

## Аннотация
Краткое описание (200 слов)

## Мотивация
Почему это изменение необходимо

## Спецификация
Техническое описание

## Обоснование
Почему выбрано такое решение

## Обратная совместимость
Влияние на существующие системы

## Тестовые случаи
Примеры использования

## Реализация
Ссылка на код
```

### Голосование

**Механизмы сигнализации:**

```
Bitcoin (BIP-9):
┌─────────────────────────────────────┐
│ Coinbase transaction                │
│ └── version bits                    │
│     └── bit N = поддержка BIP-XXX   │
└─────────────────────────────────────┘

Порог: 95% за 2016 блоков (~2 недели)
```

**On-chain голосование (Tezos):**
```
Период 1: Предложение (выбор из кандидатов)
Период 2: Тестирование (исследование на testnet)
Период 3: Голосование (супербольшинство 80%)
Период 4: Активация (автоматическое обновление)
```

### Роль сообщества

**Участники governance:**

| Участник | Роль | Влияние |
|----------|------|---------|
| Core developers | Написание кода | Высокое (техническое) |
| Майнеры | Сигнализация, обновление | Высокое (прямое) |
| Node operators | Выбор версии | Среднее |
| Биржи | Листинг, naming | Высокое (экономическое) |
| Пользователи | Выбор сети | Среднее |

---

## 6. Технические аспекты

### Как происходит разделение

```
Шаг 1: Announcement
├── Публикация изменений
├── Назначение блока активации
└── Подготовка инфраструктуры

Шаг 2: Pre-fork
├── Обновление узлов (новая версия)
├── Биржи готовят поддержку
└── Кошельки обновляются

Шаг 3: Fork block
├── Достигнут целевой блок
├── Новые правила активируются
└── Возможное разделение цепи

Шаг 4: Post-fork
├── Две независимые сети
├── Replay protection активна
└── Торговля новыми токенами
```

### Replay Attack защита

**Проблема:**
```
До форка: Alice имеет 1 BTC
После форка: Alice имеет 1 BTC и 1 BCH

Атака без защиты:
1. Alice отправляет 1 BTC → Bob
2. Злоумышленник копирует транзакцию
3. Транзакция валидна и на BCH цепи
4. Alice теряет и BCH тоже!
```

**Решения:**

```python
# 1. Изменение формата транзакции
class Transaction:
    def __init__(self):
        self.version = 1
        self.chain_id = "BTC"  # или "BCH"
        # ...

# 2. SIGHASH_FORKID (BCH)
# Добавление fork_id в хэш подписи
def sign_hash(self):
    data = self.serialize()
    data += self.fork_id  # Уникальный ID форка
    return hash(data)

# 3. Opt-in replay protection
# Добавление OP_RETURN с идентификатором сети
```

**Типы защиты:**

| Тип | Описание | Пример |
|-----|----------|--------|
| Strong replay protection | Обязательная несовместимость | BCH (SIGHASH_FORKID) |
| Opt-in protection | Пользователь выбирает | Добавление OP_RETURN |
| No protection | Риск для пользователей | Ethereum Classic (изначально) |

### Что делать пользователям при форке

**До форка:**
```
1. ☐ Вывести средства с бирж на личный кошелёк
2. ☐ Убедиться, что контролируете приватные ключи
3. ☐ Записать seed phrase
4. ☐ Не совершать транзакции за ~24 часа до форка
```

**Во время форка:**
```
1. ☐ НЕ совершать транзакции
2. ☐ Дождаться подтверждения стабильности сети
3. ☐ Следить за официальными анонсами
```

**После форка:**
```
1. ☐ Дождаться replay protection
2. ☐ Разделить монеты (split coins)
3. ☐ Обновить программное обеспечение
4. ☐ Проверить балансы на обеих цепях
```

**Процесс разделения монет:**
```
Исходный адрес: 1ABC... (содержит BTC и BCH)

Шаг 1: Отправить BTC на новый адрес 1XYZ...
        └── Транзакция может быть скопирована на BCH

Шаг 2: Использовать coin splitting service
        └── Специальная транзакция, валидная только на одной цепи

Шаг 3: После разделения
        ├── BTC на адресе 1XYZ...
        └── BCH на адресе 1ABC... (или другом)
```

---

## Заключение

Форки — это неотъемлемая часть эволюции блокчейн-технологий. Они позволяют:

- **Обновлять протоколы** без создания новых сетей (soft fork)
- **Экспериментировать** с альтернативными подходами (hard fork)
- **Решать конфликты** в сообществе путём разделения

Понимание механизмов форков необходимо для:
- Безопасного хранения криптовалют
- Участия в governance
- Принятия инвестиционных решений
- Разработки блокчейн-приложений

---

## Дополнительные ресурсы

- [BIP Repository](https://github.com/bitcoin/bips)
- [EIP Repository](https://github.com/ethereum/EIPs)
- [Bitcoin Cash History](https://www.bitcoin.com/bitcoin-cash/)
- [Ethereum Classic Declaration](https://ethereumclassic.org/)
