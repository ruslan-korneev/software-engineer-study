# Криптокошельки

## Что такое криптокошелёк

### Определение

**Криптокошелёк** — это программное или аппаратное средство для управления криптовалютными активами. Важно понимать, что кошелёк не хранит монеты напрямую — все криптовалюты существуют только в блокчейне в виде записей о транзакциях.

### Хранение ключей, а не монет

Криптокошелёк хранит:
- **Приватный ключ** — секретный ключ для подписи транзакций
- **Публичный ключ** — производный от приватного, используется для генерации адреса
- **Адрес** — идентификатор для получения средств (хеш публичного ключа)

```
Приватный ключ → Публичный ключ → Адрес
     (secret)        (public)      (0x...)
```

### Адреса и балансы

Баланс кошелька — это сумма всех непотраченных выходов транзакций (UTXO) или состояние аккаунта в блокчейне. Кошелёк просто читает эти данные из блокчейна.

---

## Приватные и публичные ключи

### Генерация ключей

Криптографические ключи генерируются с использованием эллиптической кривой (ECDSA для Bitcoin, secp256k1).

```python
from ecdsa import SigningKey, SECP256k1
import hashlib

# Генерация приватного ключа
private_key = SigningKey.generate(curve=SECP256k1)
private_key_hex = private_key.to_string().hex()
print(f"Приватный ключ: {private_key_hex}")

# Получение публичного ключа
public_key = private_key.get_verifying_key()
public_key_hex = public_key.to_string().hex()
print(f"Публичный ключ: {public_key_hex}")
```

### Связь между ключами

```
Приватный ключ (256 бит)
        ↓
    ECDSA умножение на базовую точку кривой
        ↓
Публичный ключ (512 бит = координаты x, y)
        ↓
    SHA256 + RIPEMD160
        ↓
Адрес кошелька
```

### Безопасность приватного ключа

Приватный ключ — это **единственное доказательство владения** криптовалютой:
- Тот, кто знает приватный ключ, контролирует средства
- Потеря ключа = потеря доступа к средствам навсегда
- Компрометация ключа = кража средств

### Пример создания Ethereum-адреса на Python

```python
from eth_keys import keys
from eth_utils import keccak
import os

# Генерация случайного приватного ключа (32 байта)
private_key_bytes = os.urandom(32)
private_key = keys.PrivateKey(private_key_bytes)

# Публичный ключ
public_key = private_key.public_key

# Ethereum адрес (последние 20 байт Keccak-256 от публичного ключа)
address = public_key.to_checksum_address()

print(f"Приватный ключ: 0x{private_key_bytes.hex()}")
print(f"Публичный ключ: {public_key}")
print(f"Адрес: {address}")
```

---

## Типы кошельков

### Hot Wallets (Горячие кошельки)

Горячие кошельки постоянно подключены к интернету. Удобны для частых транзакций, но менее безопасны.

#### Веб-кошельки
- Работают в браузере
- Примеры: MetaMask, MyEtherWallet
- **Плюсы**: удобство, быстрый доступ
- **Минусы**: уязвимы к фишингу, зависят от сервера

#### Десктопные кошельки
- Устанавливаются на компьютер
- Примеры: Electrum, Exodus, Bitcoin Core
- **Плюсы**: полный контроль, работа с нодой
- **Минусы**: уязвимы к вирусам

#### Мобильные кошельки
- Приложения для смартфонов
- Примеры: Trust Wallet, Coinbase Wallet
- **Плюсы**: мобильность, QR-коды
- **Минусы**: риск потери/кражи телефона

### Cold Wallets (Холодные кошельки)

Холодные кошельки не подключены к интернету. Максимальная безопасность для долгосрочного хранения.

#### Paper Wallets (Бумажные кошельки)
- Приватный и публичный ключи напечатаны на бумаге
- Генерируются офлайн
- **Плюсы**: полностью офлайн, бесплатно
- **Минусы**: могут быть повреждены, неудобны для транзакций

#### Hardware Wallets (Аппаратные кошельки)
- Специализированные устройства для хранения ключей
- Примеры: Ledger Nano, Trezor
- **Плюсы**: высокая безопасность, подпись транзакций офлайн
- **Минусы**: стоимость, риск потери устройства

```
┌─────────────────────────────────────────┐
│         Hardware Wallet                  │
│  ┌───────────────────────────────────┐  │
│  │ Secure Element (защищённый чип)   │  │
│  │ - Хранит приватный ключ           │  │
│  │ - Подписывает транзакции внутри   │  │
│  │ - Ключ НИКОГДА не покидает чип    │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### Custodial vs Non-custodial

| Характеристика | Custodial | Non-custodial |
|----------------|-----------|---------------|
| Кто хранит ключи | Сервис (биржа) | Пользователь |
| Контроль | Ограниченный | Полный |
| Ответственность | На сервисе | На пользователе |
| Примеры | Binance, Coinbase | MetaMask, Ledger |
| Риски | Взлом биржи, блокировка | Потеря seed-фразы |

**"Not your keys, not your coins"** — золотое правило криптовалют.

---

## Seed-фраза (мнемоническая фраза)

### BIP-39 стандарт

**BIP-39** (Bitcoin Improvement Proposal 39) определяет стандарт генерации мнемонических фраз для создания детерминированных кошельков.

Словарь BIP-39 содержит **2048 слов** на разных языках.

### 12/24 слова

```
Энтропия     | Контрольная сумма | Всего бит | Слов
-------------|-------------------|-----------|------
128 бит      | 4 бита            | 132 бит   | 12
256 бит      | 8 бит             | 264 бит   | 24
```

Пример seed-фразы (12 слов):
```
abandon ability able about above absent absorb abstract absurd abuse access accident
```

### Процесс генерации

```python
from mnemonic import Mnemonic

# Создание генератора для английского языка
mnemo = Mnemonic("english")

# Генерация мнемонической фразы (128 бит энтропии = 12 слов)
words = mnemo.generate(strength=128)
print(f"Seed-фраза: {words}")

# Проверка валидности фразы
is_valid = mnemo.check(words)
print(f"Валидна: {is_valid}")

# Преобразование в seed (512 бит)
seed = mnemo.to_seed(words, passphrase="")
print(f"Seed: {seed.hex()}")
```

### Восстановление кошелька

Seed-фраза позволяет полностью восстановить кошелёк и все его адреса на любом совместимом устройстве:

```
Seed-фраза (12/24 слова)
        ↓
    PBKDF2 (2048 итераций)
        ↓
    Master Seed (512 бит)
        ↓
    Master Private Key + Chain Code
        ↓
    Все производные ключи и адреса
```

### Безопасное хранение seed-фразы

**Правильно:**
- Записать на бумаге или металле
- Хранить в сейфе или банковской ячейке
- Разделить на части (Shamir's Secret Sharing)
- Сделать несколько копий в разных местах

**Неправильно:**
- Хранить в цифровом виде (файл, фото, облако)
- Отправлять по email или мессенджеру
- Вводить на подозрительных сайтах
- Хранить вместе с устройством кошелька

---

## HD кошельки (Hierarchical Deterministic)

### BIP-32 стандарт

**BIP-32** определяет иерархическую структуру генерации ключей из одного master seed.

```
Master Seed
    │
    └── Master Private Key + Chain Code
            │
            ├── Child Key 0
            ├── Child Key 1
            ├── Child Key 2
            │       │
            │       ├── Grandchild Key 0
            │       └── Grandchild Key 1
            └── ...
```

### BIP-44 стандарт

**BIP-44** определяет структуру путей деривации для мультивалютных кошельков:

```
m / purpose' / coin_type' / account' / change / address_index
```

| Уровень | Значение | Описание |
|---------|----------|----------|
| purpose | 44' | BIP-44 |
| coin_type | 0' (BTC), 60' (ETH) | Тип криптовалюты |
| account | 0', 1', ... | Аккаунт пользователя |
| change | 0 (external), 1 (internal) | Внешний/сдача |
| address_index | 0, 1, 2, ... | Индекс адреса |

### Derivation Paths (Пути деривации)

```python
from hdwallet import HDWallet
from hdwallet.symbols import BTC, ETH

# Bitcoin путь: m/44'/0'/0'/0/0
btc_path = "m/44'/0'/0'/0/0"

# Ethereum путь: m/44'/60'/0'/0/0
eth_path = "m/44'/60'/0'/0/0"

# Пример деривации
hdwallet = HDWallet(symbol=ETH)
hdwallet.from_mnemonic("abandon ability able about above absent absorb abstract absurd abuse access accident")

# Деривация по пути
hdwallet.from_path(eth_path)
print(f"Адрес: {hdwallet.p2pkh_address()}")
print(f"Приватный ключ: {hdwallet.private_key()}")
```

### Преимущества HD кошельков

1. **Один backup** — seed-фраза восстанавливает все ключи
2. **Приватность** — новый адрес для каждой транзакции
3. **Организация** — разные аккаунты для разных целей
4. **Совместимость** — один seed для разных криптовалют

---

## Безопасность кошельков

### Лучшие практики

1. **Используйте аппаратный кошелёк** для крупных сумм
2. **Никогда не делитесь** приватным ключом или seed-фразой
3. **Проверяйте адреса** перед отправкой (особенно первый и последние символы)
4. **Используйте разные кошельки** для разных целей:
   - Hot wallet — для небольших сумм и DeFi
   - Cold wallet — для долгосрочного хранения
5. **Обновляйте ПО** кошелька регулярно
6. **Включите 2FA** где возможно

### Распространённые ошибки

```
❌ Хранение seed-фразы в заметках телефона
❌ Скриншот seed-фразы
❌ Отправка seed в мессенджере "самому себе"
❌ Использование одного пароля везде
❌ Подключение к DApps без проверки
❌ Игнорирование предупреждений кошелька
```

### Фишинг и скам

**Типичные схемы мошенничества:**

1. **Фишинговые сайты** — копии популярных кошельков
   ```
   ✗ metamask-wallet.io (фишинг)
   ✓ metamask.io (официальный)
   ```

2. **Fake airdrops** — запрос seed-фразы для "получения" токенов

3. **Malicious approvals** — бесконечные разрешения на токены
   ```solidity
   // Опасно: unlimited approval
   approve(spender, type(uint256).max)

   // Безопаснее: конкретная сумма
   approve(spender, exactAmount)
   ```

4. **Clipboard hijacking** — вирус подменяет скопированный адрес

### Multi-signature кошельки

**Multisig** требует несколько подписей для выполнения транзакции:

```
2-of-3 Multisig:
┌─────────────────────────────────────┐
│ Для транзакции нужны 2 из 3 ключей │
│                                     │
│   Ключ A ✓                          │
│   Ключ B ✓    → Транзакция одобрена │
│   Ключ C ✗                          │
└─────────────────────────────────────┘
```

**Применение:**
- Корпоративные кошельки (несколько подписантов)
- Дополнительная безопасность (ключи в разных местах)
- DAO казначейства

**Примеры multisig решений:**
- Gnosis Safe (Ethereum)
- Bitcoin Core native multisig

---

## Популярные кошельки

### MetaMask

**Тип:** Hot wallet, non-custodial, браузерное расширение/мобильное приложение

**Особенности:**
- Поддержка Ethereum и EVM-совместимых сетей
- Встроенный swap токенов
- Подключение к DApps
- Импорт аппаратных кошельков

```javascript
// Подключение к MetaMask из DApp
async function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
        });
        console.log('Подключён:', accounts[0]);
    }
}
```

### Trust Wallet

**Тип:** Hot wallet, non-custodial, мобильное приложение

**Особенности:**
- Мультивалютный (поддержка 100+ блокчейнов)
- Встроенный браузер DApps
- Стейкинг криптовалют
- Покупка крипты картой

### Ledger

**Тип:** Cold wallet, hardware, non-custodial

**Модели:**
- **Ledger Nano S Plus** — бюджетный вариант
- **Ledger Nano X** — Bluetooth, больше памяти
- **Ledger Stax** — E-ink экран

**Безопасность:**
- Secure Element чип (CC EAL5+)
- PIN-код для доступа
- Подпись транзакций на устройстве
- Проверка адреса на экране устройства

### Пример использования Ledger с Python

```python
from ledgerblue.comm import getDongle

# Подключение к Ledger
dongle = getDongle(True)

# Получение публичного ключа Ethereum
# APDU команда для Ethereum app
apdu = bytes.fromhex("e0020100150480000000800000000000000000000000")
response = dongle.exchange(apdu)

public_key = response[1:65].hex()
address = response[65:85].hex()
print(f"Адрес: 0x{address}")
```

---

## Сравнительная таблица кошельков

| Кошелёк | Тип | Безопасность | Удобство | Стоимость |
|---------|-----|--------------|----------|-----------|
| MetaMask | Hot | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Бесплатно |
| Trust Wallet | Hot | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Бесплатно |
| Ledger | Cold | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | $79-279 |
| Trezor | Cold | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | $69-219 |
| Paper Wallet | Cold | ⭐⭐⭐⭐ | ⭐ | Бесплатно |

---

## Заключение

Криптокошелёк — это ворота в мир блокчейна. Выбор кошелька зависит от:
- **Суммы активов** — для крупных сумм используйте hardware wallet
- **Частоты использования** — для DeFi нужен hot wallet
- **Технических навыков** — non-custodial требует ответственности

**Главные правила:**
1. Никогда не делитесь seed-фразой
2. Проверяйте адреса перед отправкой
3. Используйте разные кошельки для разных целей
4. Регулярно проверяйте approvals токенов
