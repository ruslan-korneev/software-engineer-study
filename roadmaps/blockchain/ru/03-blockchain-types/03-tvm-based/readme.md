# TVM-based блокчейны

## Что такое TVM (TON Virtual Machine)

**TVM (TON Virtual Machine)** — это виртуальная машина, разработанная для блокчейна TON (The Open Network). Она представляет собой стековую машину Тьюринга, оптимизированную для выполнения смарт-контрактов в распределённой асинхронной среде.

### Ключевые особенности TVM

| Характеристика | Описание |
|----------------|----------|
| **Архитектура** | Стековая машина с несколькими стеками |
| **Размер ячейки** | До 1023 бит данных + до 4 ссылок на другие ячейки |
| **Криптография** | Встроенная поддержка Ed25519, SHA-256, и других алгоритмов |
| **Газ** | Детерминированная модель газа для предсказуемых затрат |

## Отличия от EVM (Ethereum Virtual Machine)

```
┌─────────────────────┬───────────────────────┬───────────────────────┐
│    Параметр         │         EVM           │         TVM           │
├─────────────────────┼───────────────────────┼───────────────────────┤
│ Модель исполнения   │ Синхронная            │ Асинхронная           │
│ Взаимодействие      │ Вызовы функций        │ Обмен сообщениями     │
│ Хранение данных     │ Key-value (256 бит)   │ Ячейки (cells)        │
│ Атомарность         │ Транзакция атомарна   │ Сообщения независимы  │
│ Шардинг             │ Нет (Layer 1)         │ Встроенный            │
│ Адресация           │ 20 байт (160 бит)     │ workchain_id + hash   │
└─────────────────────┴───────────────────────┴───────────────────────┘
```

### Синхронный vs Асинхронный подход

**EVM (синхронный):**
```
Контракт A → вызывает → Контракт B → возвращает → Контракт A
     ↓         (в одной транзакции)        ↓
     └──────────────────────────────────────┘
```

**TVM (асинхронный):**
```
Контракт A → отправляет сообщение → [Очередь] → Контракт B
                                                    ↓
Контракт A ← получает ответ ← [Очередь] ← отправляет ответ
```

## Actor Model и асинхронный обмен сообщениями

TVM использует **Actor Model** — парадигму параллельных вычислений, где каждый смарт-контракт является независимым "актором":

### Принципы Actor Model в TVM

1. **Изоляция** — каждый контракт имеет собственное состояние
2. **Асинхронность** — контракты общаются только через сообщения
3. **Неблокирующие операции** — контракт не ждёт ответа
4. **Гарантия доставки** — сообщения гарантированно доставляются (или транзакция откатывается)

```
┌─────────────────────────────────────────────────────────────┐
│                     Модель акторов в TVM                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐    сообщение     ┌─────────┐                 │
│   │ Actor A │ ───────────────► │ Actor B │                 │
│   │ (wallet)│                  │ (DEX)   │                 │
│   └─────────┘                  └────┬────┘                 │
│        ▲                            │                       │
│        │         сообщение          │                       │
│        └────────────────────────────┘                       │
│                                                             │
│   Каждый актор:                                            │
│   • Имеет уникальный адрес                                 │
│   • Хранит своё состояние                                  │
│   • Обрабатывает входящие сообщения                        │
│   • Может создавать новые сообщения                        │
└─────────────────────────────────────────────────────────────┘
```

### Типы сообщений в TVM

| Тип | Описание | Пример |
|-----|----------|--------|
| **Internal** | Между контрактами | Перевод токенов |
| **External-in** | От внешнего мира к контракту | Запрос от пользователя |
| **External-out** | От контракта во внешний мир | Логи, события |

## Шардинг (Sharding) архитектура

TVM изначально спроектирован для **бесконечного шардинга** — возможности делить сеть на произвольное количество частей:

### Структура шардинга в TON

```
                        ┌─────────────────┐
                        │   Masterchain   │
                        │   (workchain -1)│
                        └────────┬────────┘
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
    ┌──────┴──────┐       ┌──────┴──────┐       ┌──────┴──────┐
    │ Workchain 0 │       │ Workchain 1 │       │ Workchain N │
    │ (basechain) │       │  (custom)   │       │  (custom)   │
    └──────┬──────┘       └─────────────┘       └─────────────┘
           │
    ┌──────┼──────┬──────┐
    │      │      │      │
 Shard  Shard  Shard  Shard
  0/4    1/4    2/4    3/4
```

### Особенности шардинга

- **Masterchain** — хранит конфигурацию сети и состояние валидаторов
- **Workchains** — независимые блокчейны для пользовательских контрактов
- **Shardchains** — динамическое деление workchain при высокой нагрузке
- **Hypercube routing** — эффективная маршрутизация сообщений между шардами

## Языки программирования для TVM

### FunC

**FunC** — низкоуровневый язык, компилируемый в Fift, затем в TVM bytecode:

```func
;; Простой контракт кошелька на FunC
#include "stdlib.fc";

() recv_internal(int my_balance, int msg_value, cell in_msg_full, slice in_msg_body) impure {
    if (in_msg_body.slice_empty?()) { ;; пустое сообщение
        return ();
    }

    int op = in_msg_body~load_uint(32);

    if (op == 0x12345678) { ;; transfer operation
        slice destination = in_msg_body~load_msg_addr();
        int amount = in_msg_body~load_coins();

        send_raw_message(
            begin_cell()
                .store_uint(0x10, 6)
                .store_slice(destination)
                .store_coins(amount)
                .store_uint(0, 107)
            .end_cell(),
            1 ;; pay transfer fees separately
        );
    }
}
```

### Tact

**Tact** — высокоуровневый язык с TypeScript-подобным синтаксисом:

```tact
import "@stdlib/deploy";

message Transfer {
    to: Address;
    amount: Int as coins;
}

contract SimpleWallet with Deployable {
    owner: Address;

    init(owner: Address) {
        self.owner = owner;
    }

    receive(msg: Transfer) {
        require(sender() == self.owner, "Only owner can transfer");

        send(SendParameters{
            to: msg.to,
            value: msg.amount,
            mode: SendRemainingValue,
            body: "Transfer from wallet".asComment()
        });
    }

    get fun balance(): Int {
        return myBalance();
    }
}
```

### Fift

**Fift** — ассемблер для TVM, используется для низкоуровневых операций:

```fift
"Asm.fif" include

<{ SETCP0 ACCEPT
   DUP IFNOTRET
   16 LSHIFT
   SWAP
   OVER AND
   0 PUSHINT
   EQUAL
}>s constant counter-code
```

### Сравнение языков

| Язык | Уровень | Удобство | Контроль | Использование |
|------|---------|----------|----------|---------------|
| **Fift** | Низкий | Сложный | Полный | Системные контракты |
| **FunC** | Средний | Умеренный | Высокий | Продакшн контракты |
| **Tact** | Высокий | Простой | Умеренный | Быстрая разработка |

## TVM-based блокчейны

На базе TVM или его модификаций работают несколько блокчейнов:

| Блокчейн | Описание | Статус |
|----------|----------|--------|
| **TON** | The Open Network, оригинальный проект | Активный |
| **Everscale** | Форк TON (бывший Free TON) | Активный |
| **Venom** | Корпоративный блокчейн на базе Everscale | Активный |

## Преимущества TVM-архитектуры

1. **Масштабируемость** — встроенный шардинг позволяет обрабатывать миллионы транзакций
2. **Асинхронность** — эффективная параллельная обработка
3. **Гибкость** — возможность создания кастомных workchains
4. **Эффективность** — оптимизированное хранение через ячейки

## Недостатки и сложности

1. **Сложность разработки** — асинхронная модель требует другого мышления
2. **Отладка** — сложнее отслеживать цепочки сообщений
3. **Атомарность** — нет гарантии атомарного выполнения нескольких операций
4. **Экосистема** — меньше инструментов и библиотек по сравнению с EVM

## Дополнительные ресурсы

- [TON Documentation](https://docs.ton.org/)
- [Tact Language](https://tact-lang.org/)
- [TVM Whitepaper](https://ton.org/tvm.pdf)
- [Everscale Documentation](https://docs.everscale.network/)
