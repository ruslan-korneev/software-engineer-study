# AMQP 1.0

## Введение

**AMQP 1.0** — это международный стандарт протокола обмена сообщениями, принятый ISO и OASIS. Несмотря на схожее название с AMQP 0-9-1, это совершенно другой протокол с иной архитектурой и семантикой. RabbitMQ поддерживает AMQP 1.0 через плагин `rabbitmq_amqp1_0`.

## Ключевые отличия от AMQP 0-9-1

### Архитектурные различия

| Аспект | AMQP 0-9-1 | AMQP 1.0 |
|--------|------------|----------|
| Модель | Программируемый брокер | Peer-to-peer передача |
| Exchanges | Да, различные типы | Нет, концепция отсутствует |
| Queues | Да, объявляются клиентом | Нет, как концепция протокола |
| Bindings | Да | Нет |
| Стандартизация | Нет (только RabbitMQ) | ISO 19464, OASIS |
| Фокус | Маршрутизация сообщений | Интероперабельность |

### Философия протоколов

**AMQP 0-9-1** определяет:
- Как брокер должен работать
- Какие сущности (exchanges, queues) должны существовать
- Как маршрутизировать сообщения

**AMQP 1.0** определяет:
- Как передавать сообщения между двумя узлами
- Формат сообщений на проводе (wire format)
- Семантику передачи

## Архитектура AMQP 1.0

### Основные концепции

```
Container ←→ Connection ←→ Session ←→ Link
```

- **Container** — контейнер приложения (идентифицируется именем)
- **Connection** — TCP-соединение между контейнерами
- **Session** — двунаправленный канал для передачи данных
- **Link** — однонаправленный канал для сообщений (sender/receiver)

### Типы Link

```
Source ────[Link]────> Target

Sender:   Локальный Source → Удалённый Target
Receiver: Удалённый Source → Локальный Target
```

## Структура сообщения AMQP 1.0

Сообщение в AMQP 1.0 состоит из нескольких секций:

```
+----------------------------------+
|          Header                  |  Опционально
+----------------------------------+
|     Delivery Annotations         |  Опционально
+----------------------------------+
|     Message Annotations          |  Опционально
+----------------------------------+
|         Properties               |  Опционально
+----------------------------------+
|    Application Properties        |  Опционально
+----------------------------------+
|        Body (Data/Sequence)      |  Обязательно
+----------------------------------+
|          Footer                  |  Опционально
+----------------------------------+
```

### Секции сообщения

**Header:**
```
- durable: boolean
- priority: ubyte (0-9)
- ttl: milliseconds
- first-acquirer: boolean
- delivery-count: uint
```

**Properties:**
```
- message-id: любой тип
- user-id: binary
- to: address
- subject: string
- reply-to: address
- correlation-id: любой тип
- content-type: symbol
- content-encoding: symbol
- absolute-expiry-time: timestamp
- creation-time: timestamp
- group-id: string
- group-sequence: sequence-no
- reply-to-group-id: string
```

## Установка плагина в RabbitMQ

### Включение плагина

```bash
# Включить плагин AMQP 1.0
rabbitmq-plugins enable rabbitmq_amqp1_0

# Проверить статус
rabbitmq-plugins list | grep amqp1_0

# Перезапустить RabbitMQ (если требуется)
sudo systemctl restart rabbitmq-server
```

### Конфигурация

```erlang
% rabbitmq.conf или advanced.config

% Установка порта для AMQP 1.0 (по умолчанию использует 5672)
% Можно использовать тот же порт, что и AMQP 0-9-1
```

```bash
# rabbitmq.conf
amqp1_0.default_user = guest
amqp1_0.default_vhost = /
```

## Маппинг на RabbitMQ

### Адресация

AMQP 1.0 использует адреса для отправки и получения. RabbitMQ маппит их так:

| AMQP 1.0 Address | RabbitMQ Entity |
|------------------|-----------------|
| `/queue/my_queue` | Queue "my_queue" |
| `/exchange/my_exchange` | Exchange "my_exchange" (routing key пустой) |
| `/exchange/my_exchange/routing.key` | Exchange с routing key |
| `/topic/my_topic` | Topic exchange "amq.topic" с routing key |

### Примеры адресов

```python
# Отправка в очередь
address = "/queue/my_queue"

# Отправка в exchange с routing key
address = "/exchange/my_exchange/orders.new"

# Использование topic exchange
address = "/topic/sensors.temperature.room1"
```

## Примеры кода

### Python (python-qpid-proton)

```python
from proton import Message
from proton.handlers import MessagingHandler
from proton.reactor import Container

class Sender(MessagingHandler):
    def __init__(self, url, address, messages):
        super(Sender, self).__init__()
        self.url = url
        self.address = address
        self.messages = messages
        self.sent = 0
        self.confirmed = 0

    def on_start(self, event):
        # Создаём соединение и sender
        conn = event.container.connect(self.url)
        event.container.create_sender(conn, self.address)

    def on_sendable(self, event):
        while event.sender.credit and self.sent < self.messages:
            msg = Message(
                body=f"Сообщение #{self.sent}",
                properties={
                    "content_type": "text/plain"
                },
                application_properties={
                    "custom_property": "value"
                }
            )
            event.sender.send(msg)
            self.sent += 1
            print(f"Отправлено: {self.sent}")

    def on_accepted(self, event):
        self.confirmed += 1
        if self.confirmed == self.messages:
            print("Все сообщения подтверждены")
            event.connection.close()

    def on_disconnected(self, event):
        print("Отключено")

# Запуск sender
Container(Sender(
    url="amqp://guest:guest@localhost:5672",
    address="/queue/my_queue",
    messages=10
)).run()
```

### Python (Receiver)

```python
from proton.handlers import MessagingHandler
from proton.reactor import Container

class Receiver(MessagingHandler):
    def __init__(self, url, address):
        super(Receiver, self).__init__()
        self.url = url
        self.address = address
        self.received = 0

    def on_start(self, event):
        conn = event.container.connect(self.url)
        event.container.create_receiver(conn, self.address)
        print(f"Слушаем: {self.address}")

    def on_message(self, event):
        self.received += 1
        print(f"Получено #{self.received}: {event.message.body}")

        # Доступ к свойствам
        if event.message.application_properties:
            print(f"  Properties: {event.message.application_properties}")

    def on_connection_error(self, event):
        print(f"Ошибка соединения: {event.connection.remote_condition}")

# Запуск receiver
Container(Receiver(
    url="amqp://guest:guest@localhost:5672",
    address="/queue/my_queue"
)).run()
```

### Java (Apache Qpid JMS)

```java
import javax.jms.*;
import javax.naming.Context;
import javax.naming.InitialContext;
import java.util.Properties;

public class AMQP10Example {
    public static void main(String[] args) throws Exception {
        // Настройка JNDI
        Properties props = new Properties();
        props.put(Context.INITIAL_CONTEXT_FACTORY,
            "org.apache.qpid.jms.jndi.JmsInitialContextFactory");
        props.put("connectionfactory.myFactoryLookup",
            "amqp://localhost:5672");
        props.put("queue.myQueueLookup", "my_queue");

        Context context = new InitialContext(props);

        ConnectionFactory factory =
            (ConnectionFactory) context.lookup("myFactoryLookup");
        Destination queue = (Destination) context.lookup("myQueueLookup");

        try (Connection connection = factory.createConnection("guest", "guest");
             Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE)) {

            connection.start();

            // Отправка
            MessageProducer producer = session.createProducer(queue);
            TextMessage message = session.createTextMessage("Hello AMQP 1.0!");
            producer.send(message);
            System.out.println("Сообщение отправлено");

            // Получение
            MessageConsumer consumer = session.createConsumer(queue);
            Message received = consumer.receive(5000);
            if (received instanceof TextMessage) {
                System.out.println("Получено: " + ((TextMessage) received).getText());
            }
        }
    }
}
```

### .NET (Azure.Messaging.ServiceBus / AmqpNetLite)

```csharp
using Amqp;
using Amqp.Framing;
using System;
using System.Threading.Tasks;

class Program
{
    static async Task Main()
    {
        // Подключение
        var address = new Address("amqp://guest:guest@localhost:5672");
        var connection = await Connection.Factory.CreateAsync(address);
        var session = new Session(connection);

        // Отправка
        var sender = new SenderLink(session, "sender-link", "/queue/my_queue");

        var message = new Message("Hello from AMQP 1.0!");
        message.Properties = new Properties
        {
            MessageId = Guid.NewGuid().ToString(),
            ContentType = "text/plain"
        };
        message.ApplicationProperties = new ApplicationProperties();
        message.ApplicationProperties["custom-key"] = "custom-value";

        await sender.SendAsync(message);
        Console.WriteLine("Сообщение отправлено");

        // Получение
        var receiver = new ReceiverLink(session, "receiver-link", "/queue/my_queue");

        var received = await receiver.ReceiveAsync(TimeSpan.FromSeconds(5));
        if (received != null)
        {
            Console.WriteLine($"Получено: {received.Body}");
            receiver.Accept(received);
        }

        await sender.CloseAsync();
        await receiver.CloseAsync();
        await session.CloseAsync();
        await connection.CloseAsync();
    }
}
```

## Семантика доставки

### Delivery States (Состояния доставки)

AMQP 1.0 поддерживает три режима доставки:

| Режим | Гарантия | Описание |
|-------|----------|----------|
| At-most-once | Без гарантий | Сообщение может быть потеряно |
| At-least-once | Минимум один раз | Сообщение может дублироваться |
| Exactly-once | Ровно один раз | Требует координатора транзакций |

### Settlement Modes

```python
# Presettled (fire-and-forget)
# Отправитель не ждёт подтверждения
sender.send(msg, tag=None)

# Settled on delivery
# Receiver подтверждает после обработки
receiver.accept(delivery)
receiver.reject(delivery)
receiver.release(delivery)
```

## Сравнение с другими брокерами

### Поддержка AMQP 1.0

| Брокер | Поддержка | Примечания |
|--------|-----------|------------|
| RabbitMQ | Через плагин | Маппинг на queues/exchanges |
| Apache ActiveMQ | Нативная | Полная поддержка |
| Apache Qpid | Нативная | Референсная реализация |
| Azure Service Bus | Нативная | Основной протокол |
| Amazon MQ | Нативная | Через ActiveMQ |

## Когда использовать AMQP 1.0

### Преимущества

- **Стандартизация**: ISO/OASIS стандарт
- **Интероперабельность**: Работает между разными брокерами
- **Структурированные сообщения**: Богатый формат сообщений
- **Гибкая семантика доставки**: Различные уровни гарантий

### Используйте, когда

- Нужна интеграция с Azure Service Bus или другими AMQP 1.0 брокерами
- Требуется стандартный протокол для enterprise-систем
- Планируете миграцию между разными брокерами
- Работаете с .NET/Java экосистемой, где AMQP 1.0 хорошо поддерживается

### Ограничения в RabbitMQ

- Плагин добавляет дополнительный слой абстракции
- Не все возможности RabbitMQ доступны через AMQP 1.0
- Нет поддержки некоторых специфичных функций (например, publisher confirms работают иначе)
- Производительность может быть ниже, чем у AMQP 0-9-1

## Совместимость и миграция

### Смешанное использование

RabbitMQ позволяет использовать оба протокола одновременно:

```
AMQP 0-9-1 Client ──┐
                    ├──> RabbitMQ ──> Queue
AMQP 1.0 Client ────┘
```

- Сообщения от AMQP 1.0 клиента попадают в обычные очереди RabbitMQ
- AMQP 0-9-1 клиент может читать эти сообщения и наоборот
- Properties маппятся между протоколами автоматически

### Пример маппинга свойств

| AMQP 1.0 | AMQP 0-9-1 |
|----------|------------|
| `message-id` | `message_id` |
| `correlation-id` | `correlation_id` |
| `content-type` | `content_type` |
| `reply-to` | `reply_to` |
| `to` | exchange/routing_key |

## Диагностика

### Логирование

```bash
# Включить debug логи для AMQP 1.0
rabbitmqctl set_log_level debug

# Проверить подключения
rabbitmqctl list_connections protocol
```

### Типичные проблемы

1. **Плагин не включен**
   ```bash
   rabbitmq-plugins enable rabbitmq_amqp1_0
   ```

2. **Неправильный адрес**
   - Убедитесь в правильном формате: `/queue/name` или `/exchange/name/key`

3. **Ошибки аутентификации**
   - Проверьте credentials и vhost

## Заключение

AMQP 1.0 — это стандартизированный протокол, который обеспечивает интероперабельность между различными системами обмена сообщениями. В RabbitMQ он работает через плагин, маппируя концепции AMQP 1.0 на нативные сущности RabbitMQ. Используйте его, когда требуется интеграция с другими брокерами или соответствие стандартам, но для максимальной производительности и функциональности RabbitMQ предпочтительнее использовать AMQP 0-9-1.
