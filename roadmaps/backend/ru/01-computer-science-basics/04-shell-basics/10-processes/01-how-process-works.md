# Как работают процессы

## Что такое процесс?

**Процесс** — это экземпляр выполняющейся программы. Когда вы запускаете команду, ядро создаёт процесс, выделяет ему память и ресурсы.

```
Программа (файл на диске) → Процесс (выполняется в памяти)
```

## Атрибуты процесса

Каждый процесс имеет:

| Атрибут | Описание |
|---------|----------|
| **PID** | Process ID — уникальный номер процесса |
| **PPID** | Parent PID — PID родительского процесса |
| **UID/GID** | Пользователь и группа, от которых работает |
| **Состояние** | Running, Sleeping, Stopped, Zombie |
| **Приоритет** | Очерёдность получения CPU (nice value) |
| **Память** | Адресное пространство процесса |

## Иерархия процессов

Все процессы образуют дерево:

```
init/systemd (PID 1)
├── sshd
│   └── sshd (сессия)
│       └── bash
│           ├── vim
│           └── grep
├── cron
├── nginx
│   ├── nginx worker
│   └── nginx worker
└── docker
```

### Просмотр дерева процессов
```bash
$ pstree
systemd─┬─NetworkManager
        ├─accounts-daemon
        ├─sshd───sshd───bash───pstree
        └─...

$ pstree -p        # с PID
$ pstree -u        # с именами пользователей
```

## Жизненный цикл процесса

### 1. Создание (fork)
Родительский процесс создаёт копию себя:
```bash
$ bash             # текущий shell
$ bash             # создан дочерний shell (fork)
```

### 2. Выполнение (exec)
Дочерний процесс заменяет себя новой программой:
```bash
$ ls               # fork + exec(ls)
```

### 3. Завершение (exit)
Процесс заканчивает работу с кодом возврата:
```bash
$ echo $?          # код возврата последней команды
0                  # 0 = успех, не-0 = ошибка
```

### 4. Сбор статуса (wait)
Родитель забирает статус завершённого дочернего процесса.

## Состояния процесса

| Состояние | Символ | Описание |
|-----------|--------|----------|
| Running | R | Выполняется или готов |
| Sleeping | S | Ждёт события (ввод, таймер) |
| Disk Sleep | D | Ждёт I/O (нельзя прервать) |
| Stopped | T | Приостановлен (Ctrl+Z) |
| Zombie | Z | Завершён, но статус не забран |

```bash
$ ps aux | grep "^."
# В колонке STAT видно состояние
```

## Специальные процессы

### PID 0: swapper/sched
Процесс планировщика ядра.

### PID 1: init/systemd
Первый пользовательский процесс, родитель всех остальных:
```bash
$ ps -p 1
PID TTY          TIME CMD
  1 ?        00:00:03 systemd
```

### Процессы ядра
Заключены в квадратные скобки:
```bash
$ ps aux | grep "\["
root  2  [kthreadd]
root  3  [rcu_gp]
```

## Демоны (daemons)

**Демон** — процесс, работающий в фоне без привязки к терминалу:

```bash
$ ps aux | grep -E "nginx|mysql|ssh"
root    1234  nginx: master process
www-data 1235  nginx: worker process
mysql   2345  /usr/sbin/mysqld
```

Характеристики демонов:
- Не привязаны к терминалу (TTY = ?)
- Работают непрерывно
- Обычно запускаются при загрузке

## Переменные окружения процесса

Каждый процесс наследует окружение от родителя:

```bash
$ env                      # показать окружение
$ export MY_VAR="value"    # добавить переменную
$ printenv MY_VAR          # показать конкретную
```

### Просмотр окружения процесса
```bash
$ cat /proc/<PID>/environ | tr '\0' '\n'
```

## Файловые дескрипторы

Каждый процесс имеет открытые файлы:

```bash
$ ls -l /proc/$$/fd
0 -> /dev/pts/0    # stdin
1 -> /dev/pts/0    # stdout
2 -> /dev/pts/0    # stderr
```

## Виртуальная файловая система /proc

Информация о процессах в `/proc/<PID>/`:

```bash
$ ls /proc/$$
cmdline    # командная строка
cwd        # текущая директория
environ    # окружение
exe        # путь к исполняемому файлу
fd/        # открытые файлы
maps       # карта памяти
status     # статус процесса
```

### Примеры
```bash
$ cat /proc/$$/cmdline
bash

$ readlink /proc/$$/cwd
/home/user

$ cat /proc/$$/status | grep -E "^(Name|State|Pid)"
Name:   bash
State:  S (sleeping)
Pid:    12345
```

## Fork bomb (предупреждение)

Опасный код, создающий бесконечно процессы:
```bash
# НЕ ВЫПОЛНЯЙТЕ ЭТО!
:(){ :|:& };:
```

Защита:
```bash
$ ulimit -u        # лимит процессов
1024
```

## Практические примеры

### Найти PID процесса
```bash
$ pidof nginx
1234 1235 1236

$ pgrep -f "python script.py"
5678
```

### Информация о процессе
```bash
$ ps -p 1234 -o pid,ppid,user,comm,stat
PID   PPID  USER     COMMAND         STAT
1234  1     root     nginx           Ss
```

### Родительский процесс
```bash
$ ps -o ppid= -p $$
12340
```
