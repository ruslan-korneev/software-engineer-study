# Работа с историей (History)

## Навигация по истории

### Стрелки
| Клавиша | Действие |
|---------|----------|
| `↑` или `Ctrl + P` | Предыдущая команда (Previous) |
| `↓` или `Ctrl + N` | Следующая команда (Next) |

```bash
$ echo Hello
$ ls
$ pwd
[↑]           # pwd
[↑]           # ls
[↑]           # echo Hello
```

## Поиск в истории

### Ctrl + R — обратный поиск

Самая полезная комбинация для работы с историей:

```bash
$ [Ctrl+R]
(reverse-i-search)`':

# Начните вводить часть команды:
(reverse-i-search)`git': git push origin main
```

| Действие | Описание |
|----------|----------|
| Ввод текста | Уточнение поиска |
| `Ctrl + R` | Следующее совпадение |
| `Ctrl + S` | Предыдущее совпадение (если терминал поддерживает) |
| `Enter` | Выполнить найденную команду |
| `Esc` | Выйти, оставив команду в строке |
| `Ctrl + G` | Отмена поиска |

### Ctrl + S — прямой поиск

По умолчанию может быть отключён (XOFF). Чтобы включить:
```bash
$ stty -ixon
```

## Команда history

```bash
$ history              # показать всю историю
$ history 20           # последние 20 команд
$ history | grep git   # поиск команд с "git"
```

Пример вывода:
```
  501  cd /home/user
  502  ls -la
  503  git status
  504  git add .
  505  git commit -m "update"
```

## Раскрытие истории

### !! — последняя команда
```bash
$ apt update
Permission denied

$ sudo !!
sudo apt update        # автоматически подставлено
```

### !n — команда по номеру
```bash
$ !503                 # выполнить команду #503
git status
```

### !-n — n-ная с конца
```bash
$ !-1                  # предыдущая (то же что !!)
$ !-2                  # предпредыдущая
```

### !string — последняя начинающаяся с string
```bash
$ !git                 # последняя команда, начинающаяся с "git"
$ !cd                  # последняя команда cd
```

### !?string — последняя содержащая string
```bash
$ !?push               # последняя содержащая "push"
git push origin main
```

## Модификаторы истории

### Аргументы предыдущей команды

| Синтаксис | Значение |
|-----------|----------|
| `!$` | Последний аргумент |
| `!^` | Первый аргумент |
| `!*` | Все аргументы |
| `!:n` | n-й аргумент (0 = команда) |
| `!:n-m` | Аргументы с n по m |

```bash
$ mkdir /path/to/new/directory
$ cd !$
cd /path/to/new/directory

$ cp file1.txt file2.txt /backup/
$ ls !^
ls file1.txt               # первый аргумент

$ echo one two three
$ echo !*
echo one two three         # все аргументы
```

### Alt + . — вставить последний аргумент

Нажимайте повторно для перебора:
```bash
$ ls /var/log
$ cd [Alt+.]
$ cd /var/log

[Alt+.] ещё раз — предпоследний аргумент и т.д.
```

### Модификаторы замены

```bash
# Быстрая замена в последней команде
$ ^old^new
$ echo Hello Worlf
$ ^Worlf^World
echo Hello World
```

## Настройка истории

### Переменные окружения

```bash
# В ~/.bashrc
export HISTSIZE=10000       # команд в памяти
export HISTFILESIZE=20000   # команд в файле
export HISTCONTROL=ignoreboth:erasedups  # без дубликатов
export HISTIGNORE="ls:cd:pwd:clear"      # игнорировать простые команды
export HISTTIMEFORMAT="%F %T "           # временные метки
```

### Мгновенное сохранение
```bash
# Записывать историю после каждой команды
export PROMPT_COMMAND='history -a'
```

### Общая история для всех терминалов
```bash
export PROMPT_COMMAND='history -a; history -c; history -r'
```

## Управление историей

| Команда | Описание |
|---------|----------|
| `history -c` | Очистить историю в памяти |
| `history -w` | Записать историю в файл |
| `history -r` | Прочитать историю из файла |
| `history -a` | Добавить новые команды в файл |
| `history -d N` | Удалить команду #N |

### Удаление конфиденциальной команды
```bash
$ password=secret123        # Ой!
$ history -d $(history 1 | awk '{print $1}')
```

## Файл истории

```bash
$ cat ~/.bash_history       # файл истории
$ echo $HISTFILE            # путь к файлу
```

## Предотвращение сохранения

### Пробел в начале команды
```bash
$ export HISTCONTROL=ignorespace
$  secret-command           # с пробелом — не сохранится
```

### Команда с #
```bash
$ sensitive-data # ignore   # комментарий не влияет, но пробел перед командой — да
```

## Горячие клавиши истории

| Клавиша | Действие |
|---------|----------|
| `↑` / `Ctrl+P` | Предыдущая команда |
| `↓` / `Ctrl+N` | Следующая команда |
| `Ctrl + R` | Обратный поиск |
| `Ctrl + S` | Прямой поиск |
| `Ctrl + G` | Отмена поиска |
| `Alt + .` | Последний аргумент |
| `Alt + <` | Первая команда истории |
| `Alt + >` | Последняя команда |

## Советы

1. **Ctrl+R** — самый быстрый способ найти команду
2. **!!** полезен для добавления sudo
3. **!$** для повторного использования пути
4. **Alt+.** для быстрой вставки последнего аргумента
5. **Настройте HISTSIZE** на большее значение (10000+)
6. **HISTCONTROL=ignoreboth** убирает дубликаты и команды с пробелом
