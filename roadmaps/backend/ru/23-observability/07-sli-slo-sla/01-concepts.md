# Концепции SLI, SLO, SLA

## Введение

SLI, SLO и SLA - это фундаментальные концепции Site Reliability Engineering (SRE), которые помогают организациям измерять, управлять и гарантировать надежность своих сервисов. Эти концепции были популяризированы Google и описаны в книге "Site Reliability Engineering".

## SLI (Service Level Indicator) - Индикатор уровня обслуживания

### Что такое SLI?

**SLI** - это количественная метрика, которая измеряет определенный аспект качества обслуживания. Это конкретное числовое значение, которое можно измерить и отслеживать во времени.

### Ключевые характеристики SLI

- **Измеримость**: SLI должен быть объективно измеряемым
- **Релевантность**: SLI должен отражать опыт пользователя
- **Простота**: SLI должен быть понятным для всех заинтересованных сторон

### Типы SLI

#### 1. Доступность (Availability)

Процент времени, когда сервис доступен и функционирует.

```
Availability = (Успешные запросы / Общее количество запросов) * 100%
```

**Пример расчета:**
```
Всего запросов за день: 1,000,000
Неуспешных запросов (5xx ошибки): 500

Availability = (999,500 / 1,000,000) * 100% = 99.95%
```

#### 2. Латентность (Latency)

Время ответа сервиса на запрос пользователя.

```
Latency SLI = Процент запросов с временем ответа < X мс
```

**Пример:**
```
Запросов за час: 100,000
Запросов с латентностью < 200ms: 95,000

Latency SLI (p95) = 95,000 / 100,000 = 95%
```

#### 3. Пропускная способность (Throughput)

Количество успешно обработанных операций в единицу времени.

```
Throughput = Количество успешных операций / Время
```

#### 4. Качество данных (Data Quality)

Процент корректных ответов.

```
Data Quality = (Корректные ответы / Все ответы) * 100%
```

#### 5. Свежесть данных (Freshness)

Время с момента последнего обновления данных.

```
Freshness SLI = Процент запросов, получивших данные не старше X минут
```

### Формула SLI

Типичная формула SLI:

```
SLI = (Количество "хороших" событий / Общее количество валидных событий) * 100%
```

### Примеры SLI для различных сервисов

#### API-сервис
```yaml
sli:
  availability:
    good_events: "HTTP статус код < 500"
    valid_events: "Все HTTP запросы, кроме health checks"

  latency:
    good_events: "Запросы с временем ответа < 300ms"
    valid_events: "Все успешные запросы (2xx, 3xx)"
```

#### Система обработки очередей
```yaml
sli:
  processing_success:
    good_events: "Сообщения, успешно обработанные"
    valid_events: "Все сообщения, полученные из очереди"

  processing_latency:
    good_events: "Сообщения, обработанные за < 5 секунд"
    valid_events: "Все успешно обработанные сообщения"
```

#### База данных
```yaml
sli:
  query_success:
    good_events: "Запросы, выполненные без ошибок"
    valid_events: "Все запросы к БД"

  replication_lag:
    good_events: "Моменты времени с лагом репликации < 1 сек"
    valid_events: "Все измерения лага репликации"
```

---

## SLO (Service Level Objective) - Целевой уровень обслуживания

### Что такое SLO?

**SLO** - это целевое значение или диапазон значений для SLI, которое определяет приемлемый уровень обслуживания. SLO отвечает на вопрос: "Какой уровень надежности мы хотим достичь?"

### Структура SLO

```
SLO = SLI target за определенный период времени
```

**Пример:**
```
SLO: 99.9% запросов должны быть успешными за 30-дневный скользящий период
```

### Выбор целевых значений SLO

#### Таблица "девяток" доступности

| SLO | Допустимый простой в год | Допустимый простой в месяц | Допустимый простой в день |
|-----|-------------------------|---------------------------|--------------------------|
| 99% (две девятки) | 3.65 дня | 7.31 часа | 14.4 минуты |
| 99.9% (три девятки) | 8.77 часа | 43.83 минуты | 1.44 минуты |
| 99.95% | 4.38 часа | 21.92 минуты | 43.2 секунды |
| 99.99% (четыре девятки) | 52.6 минуты | 4.38 минуты | 8.64 секунды |
| 99.999% (пять девяток) | 5.26 минуты | 26.3 секунды | 0.86 секунды |

### Принципы установки SLO

1. **Начинайте с потребностей пользователей**
   - Какой уровень надежности ожидают пользователи?
   - Какие проблемы они готовы терпеть?

2. **Учитывайте бизнес-требования**
   - Какова стоимость простоя?
   - Какие есть контрактные обязательства?

3. **Оценивайте технические возможности**
   - Какую надежность обеспечивают зависимости?
   - Какие ресурсы доступны для поддержания SLO?

4. **Не ставьте SLO выше, чем необходимо**
   - Чем выше SLO, тем дороже его поддерживать
   - 100% SLO невозможен и не имеет смысла

### Пример определения SLO

```yaml
service: payment-api
slos:
  - name: availability
    description: "Доступность платежного API"
    sli: "Процент успешных запросов (статус < 500)"
    target: 99.95%
    window: 30d

  - name: latency_p50
    description: "Медианная латентность"
    sli: "50-й перцентиль времени ответа"
    target: "< 100ms"
    window: 30d

  - name: latency_p99
    description: "Хвостовая латентность"
    sli: "99-й перцентиль времени ответа"
    target: "< 500ms"
    window: 30d
```

### Multi-window SLO

Рекомендуется использовать несколько временных окон для одного SLO:

```yaml
windows:
  - period: 30d  # Долгосрочный тренд
    target: 99.9%
  - period: 7d   # Недельный тренд
    target: 99.9%
  - period: 1d   # Краткосрочные проблемы
    target: 99.5%  # Более мягкий таргет
```

---

## SLA (Service Level Agreement) - Соглашение об уровне обслуживания

### Что такое SLA?

**SLA** - это юридически обязывающий контракт между провайдером сервиса и клиентом, который определяет:
- Ожидаемый уровень обслуживания (обычно основан на SLO)
- Последствия несоблюдения (компенсации, штрафы)
- Исключения и ограничения

### Структура SLA

```
SLA = SLO + Последствия нарушения + Юридические условия
```

### Компоненты SLA

#### 1. Определение сервиса
```
Описание: API для обработки платежей
Эндпоинт: api.payment.example.com
Охват: Все регионы, 24/7
```

#### 2. Метрики и цели
```yaml
metrics:
  - name: Availability
    measurement: "Процент успешных HTTP запросов"
    target: 99.95%
    measurement_period: "Календарный месяц"

  - name: Response Time
    measurement: "95-й перцентиль латентности"
    target: "< 200ms"
    measurement_period: "Календарный месяц"
```

#### 3. Компенсации (Service Credits)

| Доступность | Компенсация |
|-------------|-------------|
| < 99.95% и >= 99.0% | 10% от месячного счета |
| < 99.0% и >= 95.0% | 25% от месячного счета |
| < 95.0% | 50% от месячного счета |

#### 4. Исключения

Типичные исключения из SLA:
- Плановое техническое обслуживание (с предупреждением за 7 дней)
- Форс-мажорные обстоятельства
- Проблемы на стороне клиента
- DDoS-атаки
- Действия третьих сторон

### Пример SLA документа

```markdown
# Соглашение об уровне обслуживания (SLA)

## 1. Определения

**"Доступность"** означает процент времени, когда Сервис доступен
и функционирует в соответствии со спецификацией.

**"Период простоя"** означает период времени, когда Сервис недоступен.

## 2. Обязательства по уровню обслуживания

Провайдер гарантирует месячную доступность не менее 99.9%.

## 3. Расчет компенсации

При нарушении SLA Клиент имеет право на компенсацию:

| Фактическая доступность | Компенсация |
|------------------------|-------------|
| 99.0% - 99.9%         | 10%         |
| 95.0% - 99.0%         | 25%         |
| < 95.0%               | 50%         |

## 4. Процедура получения компенсации

Клиент должен подать заявку на компенсацию в течение 30 дней
после окончания месяца, в котором произошло нарушение.
```

---

## Error Budget - Бюджет ошибок

### Что такое Error Budget?

**Error Budget** - это допустимое количество ошибок или простоя, которое "разрешено" в рамках SLO. Это инверсия SLO.

```
Error Budget = 100% - SLO
```

**Пример:**
```
SLO = 99.9%
Error Budget = 100% - 99.9% = 0.1%
```

### Расчет Error Budget

#### В запросах
```
Запросов в месяц: 10,000,000
SLO: 99.9%
Error Budget: 0.1%

Допустимые ошибки = 10,000,000 * 0.001 = 10,000 ошибок в месяц
```

#### Во времени
```
SLO: 99.9% доступности
Период: 30 дней = 43,200 минут

Error Budget = 43,200 * 0.001 = 43.2 минуты простоя в месяц
```

### Использование Error Budget

#### 1. Баланс между надежностью и развитием

```
Оставшийся Error Budget > 0:
  → Можно проводить рискованные релизы
  → Можно экспериментировать с инфраструктурой
  → Приоритет на разработку новых фич

Оставшийся Error Budget <= 0:
  → Замораживание релизов (кроме исправлений)
  → Фокус на стабилизацию
  → Расследование причин
```

#### 2. Политика Error Budget

```yaml
error_budget_policy:
  thresholds:
    - remaining: ">50%"
      actions:
        - "Обычный режим разработки"
        - "Стандартный процесс релизов"

    - remaining: "25-50%"
      actions:
        - "Усиленное тестирование перед релизами"
        - "Обзор недавних инцидентов"

    - remaining: "0-25%"
      actions:
        - "Только критические релизы"
        - "Усиленный мониторинг"
        - "Еженедельные ревью с руководством"

    - remaining: "<0%"
      actions:
        - "Заморозка релизов"
        - "Все ресурсы на стабилизацию"
        - "Post-mortem обязателен"
```

### Burn Rate - Скорость расхода Error Budget

**Burn Rate** показывает, насколько быстро расходуется Error Budget.

```
Burn Rate = (Потраченный Error Budget / Прошедшее время) / (Общий Error Budget / Период SLO)
```

| Burn Rate | Значение |
|-----------|----------|
| 1.0 | Нормальный расход, бюджет закончится точно в конце периода |
| 2.0 | Бюджет закончится в 2 раза быстрее |
| 0.5 | Бюджет расходуется медленнее нормы |
| 10.0 | Критическая скорость, срочно нужны действия |

---

## Взаимосвязь SLI, SLO, SLA и Error Budget

```
┌─────────────────────────────────────────────────────────────┐
│                         SLA                                  │
│  Юридический контракт с клиентом                           │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                       SLO                              │ │
│  │  Внутренняя цель (обычно строже SLA)                  │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │                    SLI                           │ │ │
│  │  │  Измеряемая метрика                             │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                       │ │
│  │  Error Budget = 100% - SLO                           │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Пример цепочки

```
SLI: Процент успешных запросов = 99.93%
SLO: 99.9% успешных запросов за 30 дней (внутренняя цель)
SLA: 99.5% успешных запросов (контракт с клиентом)
Error Budget: 0.1% (на основе SLO)

Текущий статус:
- SLI (99.93%) > SLO (99.9%) → SLO выполняется ✓
- SLI (99.93%) > SLA (99.5%) → SLA выполняется ✓
- Осталось 0.03% дополнительного бюджета ошибок
```

---

## Практические рекомендации

### 1. Начните с простого

```yaml
# Минимальный набор SLI для начала
slis:
  - availability: "Процент успешных запросов"
  - latency: "p99 время ответа"
```

### 2. Измеряйте с точки зрения пользователя

```python
# Плохо: измерение на сервере
server_availability = up_checks / total_checks

# Хорошо: измерение на уровне пользователя
user_success_rate = successful_user_requests / total_user_requests
```

### 3. Не стремитесь к 100%

```
100% SLO означает:
- Нулевой Error Budget
- Невозможность вносить изменения
- Бесконечные затраты на инфраструктуру
- Всё равно недостижимо
```

### 4. Регулярно пересматривайте SLO

```yaml
review_schedule:
  frequency: "Ежеквартально"
  participants:
    - "SRE команда"
    - "Product owners"
    - "Engineering leads"
  topics:
    - "Соответствие SLO ожиданиям пользователей"
    - "Стоимость поддержания текущих SLO"
    - "Необходимость добавления новых SLI"
```

---

## Заключение

SLI, SLO и SLA образуют фундамент для управления надежностью сервисов:

- **SLI** отвечает на вопрос "Что мы измеряем?"
- **SLO** отвечает на вопрос "Какого уровня мы хотим достичь?"
- **SLA** отвечает на вопрос "Что мы обещаем клиентам?"
- **Error Budget** отвечает на вопрос "Сколько ошибок мы можем себе позволить?"

Правильное использование этих концепций позволяет найти баланс между скоростью развития продукта и его надежностью, а также обеспечить прозрачную коммуникацию между техническими командами, бизнесом и клиентами.
