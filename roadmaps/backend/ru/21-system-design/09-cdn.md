# CDN (Content Delivery Network)

## Что такое CDN и зачем он нужен

**CDN (Content Delivery Network)** — это географически распределённая сеть серверов, которая доставляет контент пользователям с ближайшего к ним узла, минимизируя задержки и повышая производительность.

### Проблема без CDN

```
┌─────────────────────────────────────────────────────────────────┐
│                        БЕЗ CDN                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Пользователь (Токио)                                          │
│         │                                                       │
│         │  ~200ms латентность (через океан)                     │
│         │                                                       │
│         ▼                                                       │
│   Origin Server (Нью-Йорк)                                      │
│         │                                                       │
│   • Высокая нагрузка на один сервер                             │
│   • Все запросы идут через океан                                │
│   • Медленная загрузка для удалённых пользователей              │
│   • Риск перегрузки при пиках трафика                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Решение с CDN

```
┌─────────────────────────────────────────────────────────────────┐
│                         С CDN                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Пользователь (Токио)          Пользователь (Берлин)           │
│         │                              │                        │
│         │ ~20ms                        │ ~15ms                  │
│         ▼                              ▼                        │
│   Edge Server (Токио)           Edge Server (Франкфурт)         │
│         │                              │                        │
│         └──────────────┬───────────────┘                        │
│                        │                                        │
│                        ▼                                        │
│                Origin Server (Нью-Йорк)                         │
│                                                                 │
│   • Контент ближе к пользователю                                │
│   • Снижение нагрузки на origin                                 │
│   • Быстрая загрузка для всех регионов                          │
│   • Устойчивость к пикам трафика                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Основные преимущества CDN

| Преимущество | Описание |
|--------------|----------|
| **Низкая латентность** | Контент доставляется с ближайшего сервера |
| **Высокая доступность** | Отказ одного узла не влияет на доступность |
| **Снижение нагрузки** | Origin-сервер обслуживает меньше запросов |
| **DDoS защита** | CDN поглощает атаки на своих узлах |
| **Экономия bandwidth** | Трафик распределяется по edge-серверам |
| **SSL/TLS терминация** | HTTPS обрабатывается на edge |

---

## Как работает CDN

### Архитектура CDN

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        АРХИТЕКТУРА CDN                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          ┌─────────────────┐                            │
│                          │  Origin Server  │                            │
│                          │   (ваш сервер)  │                            │
│                          └────────┬────────┘                            │
│                                   │                                     │
│                    ┌──────────────┼──────────────┐                      │
│                    │              │              │                      │
│                    ▼              ▼              ▼                      │
│           ┌────────────┐  ┌────────────┐  ┌────────────┐                │
│           │   PoP 1    │  │   PoP 2    │  │   PoP 3    │                │
│           │  (Европа)  │  │   (Азия)   │  │ (Америка)  │                │
│           └─────┬──────┘  └─────┬──────┘  └─────┬──────┘                │
│                 │               │               │                       │
│           ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐                 │
│           ▼           ▼   ▼           ▼   ▼           ▼                 │
│       ┌──────┐   ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐           │
│       │Edge 1│   │Edge 2│ │Edge 3│ │Edge 4│ │Edge 5│ │Edge 6│           │
│       └──────┘   └──────┘ └──────┘ └──────┘ └──────┘ └──────┘           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Компоненты CDN

#### 1. Origin Server (Исходный сервер)
Ваш основной сервер, где хранится оригинальный контент.

```python
# Пример конфигурации origin для Nginx
# /etc/nginx/sites-available/origin

server {
    listen 80;
    server_name origin.example.com;

    # Статические файлы
    location /static/ {
        root /var/www/app;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API - без кэширования
    location /api/ {
        proxy_pass http://backend:8000;
        add_header Cache-Control "no-store";
    }
}
```

#### 2. PoP (Point of Presence)
Дата-центр CDN в определённом регионе, содержащий один или несколько edge-серверов.

```
┌─────────────────────────────────────────────────────────────┐
│                    PoP (Point of Presence)                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌───────────────────────────────────────────────────┐     │
│   │               Load Balancer                       │     │
│   └───────────────────────┬───────────────────────────┘     │
│                           │                                 │
│       ┌───────────────────┼───────────────────┐             │
│       │                   │                   │             │
│       ▼                   ▼                   ▼             │
│   ┌────────┐         ┌────────┐         ┌────────┐          │
│   │ Edge 1 │         │ Edge 2 │         │ Edge 3 │          │
│   │ Server │         │ Server │         │ Server │          │
│   ├────────┤         ├────────┤         ├────────┤          │
│   │ Cache  │         │ Cache  │         │ Cache  │          │
│   │ 100TB  │         │ 100TB  │         │ 100TB  │          │
│   └────────┘         └────────┘         └────────┘          │
│                                                             │
│   Компоненты PoP:                                           │
│   • DNS сервер                                              │
│   • Edge серверы с SSD кэшем                                │
│   • Балансировщик нагрузки                                  │
│   • Мониторинг и логирование                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 3. Edge Server (Пограничный сервер)
Сервер на "краю" сети, непосредственно обслуживающий пользователей.

### Процесс обработки запроса

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПРОЦЕСС ОБРАБОТКИ ЗАПРОСА                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. DNS Resolution                                                     │
│   ┌────────────┐    ┌─────────────┐    ┌─────────────────┐              │
│   │ Браузер    │───▶│ DNS         │───▶│ CDN DNS         │              │
│   │            │    │ Resolver    │    │ (Anycast)       │              │
│   └────────────┘    └─────────────┘    └────────┬────────┘              │
│                                                 │                       │
│   2. Выбор ближайшего PoP                       │                       │
│   ┌─────────────────────────────────────────────▼────────┐              │
│   │  GeoDNS определяет ближайший PoP по IP клиента       │              │
│   │  Учитывает: геолокацию, загрузку, здоровье узлов     │              │
│   └─────────────────────────────────────────────┬────────┘              │
│                                                 │                       │
│   3. Запрос к Edge Server                       │                       │
│   ┌────────────┐    HTTP Request    ┌──────────▼────────┐               │
│   │ Браузер    │───────────────────▶│ Edge Server       │               │
│   │            │                    │ (Tokyo PoP)       │               │
│   └────────────┘                    └──────────┬────────┘               │
│                                                │                        │
│   4. Cache Lookup                              │                        │
│   ┌────────────────────────────────────────────▼────────────────┐       │
│   │                                                             │       │
│   │   Cache HIT?  ───YES──▶  Отдать из кэша (быстро!)           │       │
│   │       │                                                     │       │
│   │       NO                                                    │       │
│   │       │                                                     │       │
│   │       ▼                                                     │       │
│   │   Запрос к Origin ──▶ Получить ──▶ Закэшировать ──▶ Отдать  │       │
│   │                                                             │       │
│   └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Anycast DNS

CDN использует **Anycast** — технологию, при которой один IP-адрес объявляется из множества точек мира:

```
┌─────────────────────────────────────────────────────────────────┐
│                          ANYCAST DNS                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   cdn.example.com → 203.0.113.50 (один IP для всех)             │
│                                                                 │
│                    ┌────────────────────┐                       │
│                    │   203.0.113.50     │                       │
│                    │   (Anycast IP)     │                       │
│                    └─────────┬──────────┘                       │
│                              │                                  │
│        ┌─────────────────────┼─────────────────────┐            │
│        │                     │                     │            │
│        ▼                     ▼                     ▼            │
│   ┌─────────┐          ┌─────────┐          ┌─────────┐         │
│   │ Tokyo   │          │ London  │          │New York │         │
│   │ PoP     │          │ PoP     │          │ PoP     │         │
│   │         │          │         │          │         │         │
│   │ Тот же  │          │ Тот же  │          │ Тот же  │         │
│   │   IP!   │          │   IP!   │          │   IP!   │         │
│   └─────────┘          └─────────┘          └─────────┘         │
│                                                                 │
│   BGP маршрутизация автоматически направляет                    │
│   пользователя к ближайшему PoP                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Push vs Pull CDN

CDN можно классифицировать по способу получения контента от origin-сервера.

### Pull CDN (Ленивая загрузка)

Edge-серверы запрашивают контент с origin по мере необходимости.

```
┌─────────────────────────────────────────────────────────────────┐
│                          PULL CDN                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. Первый запрос (Cache Miss)                                 │
│   ┌────────┐                 ┌───────┐           ┌────────┐     │
│   │ Client │ ──GET /img.png─▶│ Edge  │──────────▶│ Origin │     │
│   │        │                 │Server │           │ Server │     │
│   │        │◀────────────────│ (miss)│◀──────────│        │     │
│   └────────┘                 └───┬───┘           └────────┘     │
│                                  │                              │
│                            Сохранить в кэш                      │
│                                                                 │
│   2. Последующие запросы (Cache Hit)                            │
│   ┌────────┐                 ┌───────┐                          │
│   │ Client │ ──GET /img.png─▶│ Edge  │                          │
│   │        │                 │Server │  (origin не нужен)       │
│   │        │◀────────────────│ (hit) │                          │
│   └────────┘                 └───────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Конфигурация Pull CDN (Cloudflare):**

```yaml
# Cloudflare Page Rules
rules:
  - match: "*.example.com/static/*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 86400  # 24 часа
      browser_cache_ttl: 3600  # 1 час
```

**Характеристики Pull CDN:**

| Преимущества | Недостатки |
|--------------|------------|
| Простая настройка | Первый запрос медленный (cache miss) |
| Автоматическое управление | Нет контроля над тем, что кэшируется |
| Эффективное использование места | Редко запрашиваемый контент не кэшируется |
| Не нужно управлять инвалидацией | Latency при устаревании кэша |

**Когда использовать Pull CDN:**
- Сайты с большим объёмом контента
- Контент обновляется редко
- Неизвестно заранее, какой контент популярен
- Хотите минимизировать операционные затраты

### Push CDN (Активная загрузка)

Контент загружается на edge-серверы заранее, до первого запроса.

```
┌─────────────────────────────────────────────────────────────────┐
│                          PUSH CDN                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. Предварительная загрузка (Push)                            │
│   ┌────────┐                                                    │
│   │ Origin │──────┬──────────────────┬──────────────────┐       │
│   │ Server │      │                  │                  │       │
│   └────────┘      ▼                  ▼                  ▼       │
│              ┌────────┐         ┌────────┐         ┌────────┐   │
│              │ Edge 1 │         │ Edge 2 │         │ Edge 3 │   │
│              │ (Asia) │         │(Europe)│         │ (USA)  │   │
│              └────────┘         └────────┘         └────────┘   │
│                                                                 │
│   2. Все запросы - Cache Hit                                    │
│   ┌────────┐                 ┌───────┐                          │
│   │ Client │ ──GET /video───▶│ Edge  │  (контент уже есть!)     │
│   │        │◀────────────────│Server │                          │
│   └────────┘                 └───────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Пример Push CDN с AWS S3 + CloudFront:**

```python
import boto3
from botocore.config import Config

class PushCDN:
    def __init__(self):
        self.s3 = boto3.client('s3')
        self.cloudfront = boto3.client('cloudfront')
        self.bucket = 'my-cdn-origin'
        self.distribution_id = 'E1234567890'

    def push_content(self, file_path: str, key: str, content_type: str):
        """Загрузить контент на CDN origin"""
        with open(file_path, 'rb') as f:
            self.s3.put_object(
                Bucket=self.bucket,
                Key=key,
                Body=f,
                ContentType=content_type,
                CacheControl='max-age=31536000, immutable',  # 1 год
                Metadata={
                    'pushed-at': str(datetime.now())
                }
            )
        print(f"Pushed: {key}")

    def push_release(self, release_dir: str):
        """Загрузить весь релиз"""
        for root, dirs, files in os.walk(release_dir):
            for file in files:
                file_path = os.path.join(root, file)
                key = os.path.relpath(file_path, release_dir)
                content_type = self._get_content_type(file)
                self.push_content(file_path, key, content_type)

        # Инвалидировать кэш после загрузки
        self._invalidate_cache(['/*'])

    def _invalidate_cache(self, paths: list):
        """Инвалидировать кэш CloudFront"""
        self.cloudfront.create_invalidation(
            DistributionId=self.distribution_id,
            InvalidationBatch={
                'Paths': {
                    'Quantity': len(paths),
                    'Items': paths
                },
                'CallerReference': str(datetime.now().timestamp())
            }
        )

# Использование
cdn = PushCDN()
cdn.push_release('./dist/')
```

**Характеристики Push CDN:**

| Преимущества | Недостатки |
|--------------|------------|
| Нет cache miss — всегда быстро | Сложнее настройка |
| Полный контроль над контентом | Нужно управлять загрузкой |
| Предсказуемая производительность | Требует больше storage |
| Меньше запросов к origin | Ручная инвалидация |

**Когда использовать Push CDN:**
- Предварительные релизы (новые версии приложения)
- Критически важный контент (landing page)
- Известный заранее контент (видео, подкасты)
- Низкий объём контента, но высокий трафик

### Сравнение Pull vs Push

```
┌──────────────────────────────────────────────────────────────────────┐
│                     PULL vs PUSH CDN                                 │
├───────────────────────────┬──────────────────────────────────────────┤
│          PULL             │                  PUSH                    │
├───────────────────────────┼──────────────────────────────────────────┤
│                           │                                          │
│  Контент "притягивается"  │  Контент "проталкивается"                │
│  при первом запросе       │  заранее                                 │
│                           │                                          │
│  ┌──────┐   ┌──────┐      │    ┌──────┐                              │
│  │Client│──▶│ Edge │──┐   │    │Origin│──┬──┬──┐                     │
│  └──────┘   └──────┘  │   │    └──────┘  │  │  │                     │
│                       │   │              ▼  ▼  ▼                     │
│              ┌────────▼┐  │           ┌────────────┐                 │
│              │ Origin  │  │           │Edge servers│                 │
│              └─────────┘  │           └────────────┘                 │
│                           │                                          │
│  • Большой каталог        │  • Маленький каталог                     │
│  • Редкие обновления      │  • Частые обновления                     │
│  • Автоматическое         │  • Ручное управление                     │
│    управление             │                                          │
│                           │                                          │
│  Примеры:                 │  Примеры:                                │
│  • Cloudflare             │  • AWS S3 + CloudFront                   │
│  • Fastly                 │  • Статический хостинг                   │
│  • Akamai                 │  • Видеоплатформы                        │
│                           │                                          │
└───────────────────────────┴──────────────────────────────────────────┘
```

### Гибридный подход

На практике часто используется комбинация:

```python
class HybridCDN:
    """Гибридный подход: Push для критичного контента, Pull для остального"""

    def __init__(self, push_cdn, pull_cdn_url):
        self.push_cdn = push_cdn
        self.pull_cdn_url = pull_cdn_url
        self.critical_paths = ['/js/app.js', '/css/main.css', '/fonts/']

    def deploy_release(self, build_dir: str):
        """Deploy с Push для критичных файлов"""
        for root, dirs, files in os.walk(build_dir):
            for file in files:
                file_path = os.path.join(root, file)
                rel_path = '/' + os.path.relpath(file_path, build_dir)

                if self._is_critical(rel_path):
                    # Push критичный контент
                    self.push_cdn.push_content(file_path, rel_path)
                # Остальное обслуживается через Pull CDN

    def _is_critical(self, path: str) -> bool:
        return any(path.startswith(cp) for cp in self.critical_paths)

    def get_url(self, path: str) -> str:
        """Получить URL для ресурса"""
        # Оба типа контента доступны через один домен
        return f"{self.pull_cdn_url}{path}"
```

---

## Типы контента для CDN

### Статический контент

Файлы, которые не меняются между запросами — идеальный кандидат для CDN.

```
┌─────────────────────────────────────────────────────────────────┐
│                    СТАТИЧЕСКИЙ КОНТЕНТ                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Идеально подходит для CDN:                                    │
│                                                                 │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │   Images    │  │    CSS      │  │ JavaScript  │             │
│   │  .jpg .png  │  │   .css      │  │    .js      │             │
│   │  .webp .svg │  │             │  │             │             │
│   └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │   Fonts     │  │   Videos    │  │  Downloads  │             │
│   │ .woff .woff2│  │  .mp4 .webm │  │  .pdf .zip  │             │
│   │  .ttf .eot  │  │             │  │             │             │
│   └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│   Рекомендуемые настройки:                                      │
│   • Cache-Control: public, max-age=31536000, immutable          │
│   • Версионирование в URL: /js/app.v2.3.1.js                    │
│   • Сжатие: gzip/brotli                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Nginx конфигурация для статики:**

```nginx
# Статические файлы с агрессивным кэшированием
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";

    # Включить gzip
    gzip on;
    gzip_types text/css application/javascript image/svg+xml;

    # Brotli (если установлен модуль)
    brotli on;
    brotli_types text/css application/javascript image/svg+xml;
}
```

### Динамический контент

Контент, генерируемый на лету. Требует особого подхода к кэшированию.

```
┌─────────────────────────────────────────────────────────────────┐
│                   ДИНАМИЧЕСКИЙ КОНТЕНТ                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Типы динамического контента:                                  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  1. Персонализированный (НЕ кэшировать)                 │   │
│   │     • Профиль пользователя                              │   │
│   │     • Корзина покупок                                   │   │
│   │     • Личные сообщения                                  │   │
│   │     Cache-Control: private, no-store                    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  2. Общий динамический (можно кэшировать)               │   │
│   │     • Главная страница                                  │   │
│   │     • Список товаров (без персонализации)               │   │
│   │     • Новости                                           │   │
│   │     Cache-Control: public, max-age=60, s-maxage=300     │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  3. API ответы                                          │   │
│   │     • GET запросы (можно кэшировать)                    │   │
│   │     • POST/PUT/DELETE (НЕ кэшировать)                   │   │
│   │     Vary: Authorization, Accept-Language                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Edge Side Includes (ESI) для частично динамического контента:**

```html
<!-- Страница с ESI -->
<!DOCTYPE html>
<html>
<head>
    <title>Главная</title>
</head>
<body>
    <!-- Статичная часть (кэшируется) -->
    <header>
        <nav>...</nav>
    </header>

    <!-- Динамическая часть (ESI тег) -->
    <esi:include src="/fragments/user-greeting" />

    <!-- Статичный контент -->
    <main>
        <esi:include src="/fragments/featured-products"
                     onerror="continue"
                     ttl="5m" />
    </main>

    <!-- Кэшируемый footer -->
    <footer>...</footer>
</body>
</html>
```

### Стриминг контента

Видео и аудио стриминг требует специальной инфраструктуры CDN.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      СТРИМИНГ ЧЕРЕЗ CDN                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Технологии стриминга:                                                 │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                        HLS (HTTP Live Streaming)                │   │
│   │                                                                 │   │
│   │   Origin                  Edge                    Client        │   │
│   │   ┌──────┐               ┌──────┐               ┌──────┐        │   │
│   │   │Video │──transcode───▶│Cache │──────────────▶│Player│        │   │
│   │   │ .mp4 │               │      │               │      │        │   │
│   │   └──────┘               └──────┘               └──────┘        │   │
│   │                                                                 │   │
│   │   Выходные файлы:                                               │   │
│   │   • playlist.m3u8 (мастер плейлист)                             │   │
│   │   • 720p/playlist.m3u8                                          │   │
│   │   • 720p/segment001.ts, segment002.ts, ...                      │   │
│   │   • 1080p/playlist.m3u8                                         │   │
│   │   • 1080p/segment001.ts, segment002.ts, ...                     │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                           DASH                                  │   │
│   │   (Dynamic Adaptive Streaming over HTTP)                        │   │
│   │                                                                 │   │
│   │   • manifest.mpd (Media Presentation Description)               │   │
│   │   • video_720p_segment_1.m4s                                    │   │
│   │   • video_1080p_segment_1.m4s                                   │   │
│   │   • audio_128k_segment_1.m4s                                    │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   Adaptive Bitrate:                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   Клиент автоматически переключается между качествами           │   │
│   │                                                                 │   │
│   │   Bandwidth:  10 Mbps ──▶ 1080p                                 │   │
│   │               5 Mbps  ──▶ 720p                                  │   │
│   │               2 Mbps  ──▶ 480p                                  │   │
│   │               500 Kbps ─▶ 360p                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Пример HLS манифеста:**

```m3u8
#EXTM3U
#EXT-X-VERSION:3

# Мастер плейлист с вариантами качества
#EXT-X-STREAM-INF:BANDWIDTH=800000,RESOLUTION=640x360
360p/playlist.m3u8

#EXT-X-STREAM-INF:BANDWIDTH=1400000,RESOLUTION=842x480
480p/playlist.m3u8

#EXT-X-STREAM-INF:BANDWIDTH=2800000,RESOLUTION=1280x720
720p/playlist.m3u8

#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080
1080p/playlist.m3u8
```

**Конфигурация CDN для видео:**

```nginx
# Nginx конфигурация для HLS стриминга
location ~ \.m3u8$ {
    # Плейлисты - короткий TTL для live стриминга
    add_header Cache-Control "public, max-age=2";
    add_header Access-Control-Allow-Origin "*";
}

location ~ \.ts$ {
    # Сегменты - длинный TTL (они иммутабельны)
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*";
}

location ~ \.m4s$ {
    # DASH сегменты
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*";
}
```

---

## Кэширование в CDN

### Cache-Control Headers

HTTP заголовки управляют поведением кэша на всех уровнях.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       CACHE-CONTROL ДИРЕКТИВЫ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                        Срок жизни                               │   │
│   ├─────────────────────────────────────────────────────────────────┤   │
│   │  max-age=3600         Кэшировать 1 час (для браузера)           │   │
│   │  s-maxage=86400       Кэшировать 24ч (для CDN/proxy)            │   │
│   │  stale-while-revalidate=60  Отдавать старый, пока обновляется   │   │
│   │  stale-if-error=3600  Отдавать старый при ошибке origin         │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Уровень кэширования                         │   │
│   ├─────────────────────────────────────────────────────────────────┤   │
│   │  public              Можно кэшировать везде (CDN, браузер)      │   │
│   │  private             Только в браузере (персональные данные)    │   │
│   │  no-store            Не кэшировать вообще                       │   │
│   │  no-cache            Всегда проверять свежесть с сервером       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      Дополнительные                             │   │
│   ├─────────────────────────────────────────────────────────────────┤   │
│   │  immutable           Контент никогда не изменится               │   │
│   │  must-revalidate     Обязательно проверить после истечения      │   │
│   │  proxy-revalidate    must-revalidate только для CDN             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Примеры заголовков для разного контента:**

```python
from fastapi import FastAPI, Response
from datetime import timedelta

app = FastAPI()

# Статические ассеты (версионированные)
@app.get("/static/{version}/{filename}")
def get_static_asset(version: str, filename: str, response: Response):
    response.headers["Cache-Control"] = "public, max-age=31536000, immutable"
    return get_file(f"static/{filename}")

# API - данные которые редко меняются
@app.get("/api/products")
def get_products(response: Response):
    response.headers["Cache-Control"] = "public, max-age=60, s-maxage=300, stale-while-revalidate=60"
    response.headers["Vary"] = "Accept-Language"
    return {"products": [...]}

# API - персонализированные данные
@app.get("/api/user/profile")
def get_profile(response: Response):
    response.headers["Cache-Control"] = "private, no-store"
    return {"user": ...}

# Главная страница
@app.get("/")
def get_homepage(response: Response):
    response.headers["Cache-Control"] = "public, max-age=0, s-maxage=60, stale-while-revalidate=30, stale-if-error=86400"
    return render_homepage()
```

### Vary Header

`Vary` указывает CDN, что ответ зависит от определённых заголовков запроса.

```
┌─────────────────────────────────────────────────────────────────┐
│                         VARY HEADER                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Без Vary:                                                     │
│   ┌────────────┐                  ┌────────────┐                │
│   │ Request 1  │                  │ Response   │                │
│   │ Accept: EN │  ──кэшируется──▶ │ English    │                │
│   └────────────┘                  └────────────┘                │
│                                                                 │
│   ┌────────────┐                  ┌────────────┐                │
│   │ Request 2  │                  │ Response   │                │
│   │ Accept: RU │  ──cache hit──▶  │ English!   │ ← Неверно!     │
│   └────────────┘                  └────────────┘                │
│                                                                 │
│   С Vary: Accept-Language                                       │
│   ┌────────────┐                  ┌────────────┐                │
│   │ Request 1  │                  │ Response   │                │
│   │ Accept: EN │  ──кэш (key=EN)─▶│ English    │                │
│   └────────────┘                  └────────────┘                │
│                                                                 │
│   ┌────────────┐                  ┌────────────┐                │
│   │ Request 2  │                  │ Response   │                │
│   │ Accept: RU │  ──кэш (key=RU)─▶│ Русский    │ ← Корректно!   │
│   └────────────┘                  └────────────┘                │
│                                                                 │
│   Популярные Vary заголовки:                                    │
│   • Vary: Accept-Encoding (gzip vs brotli vs plain)             │
│   • Vary: Accept-Language (локализация)                         │
│   • Vary: Cookie (разный контент для auth/non-auth)             │
│   • Vary: Origin (CORS)                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Cache Key

CDN использует cache key для идентификации кэшированного контента.

```python
# Стандартный cache key
cache_key = f"{scheme}://{host}{path}?{sorted_query_params}"

# Пример
# https://cdn.example.com/api/products?sort=price&category=electronics
# Cache key: https://cdn.example.com/api/products?category=electronics&sort=price

# Расширенный cache key с учётом Vary
cache_key_components = {
    "url": "https://cdn.example.com/api/products",
    "query": {"category": "electronics", "sort": "price"},
    "accept_encoding": "gzip",
    "accept_language": "en-US",
}
cache_key = hash(frozenset(cache_key_components.items()))
```

**Cloudflare Page Rules для кастомных cache keys:**

```yaml
# Игнорировать query параметры (для статики)
page_rules:
  - match: "*.example.com/static/*"
    cache_key_ignore_query_string: true

# Кэшировать по куки (для A/B тестов)
  - match: "*.example.com/*"
    cache_key:
      cookie: ["experiment_group"]
```

### Cache Invalidation

Инвалидация — удаление устаревшего контента из кэша CDN.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      СТРАТЕГИИ ИНВАЛИДАЦИИ                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. TTL-based (Time To Live)                                           │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   Контент автоматически устаревает через заданное время         │   │
│   │                                                                 │   │
│   │   + Простота: не нужно ничего делать                            │   │
│   │   - Задержка: обновления видны не сразу                         │   │
│   │                                                                 │   │
│   │   Cache-Control: max-age=3600  ──▶  Через 1 час = устарел       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   2. Purge (Принудительная очистка)                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   Явный запрос на удаление контента из кэша                     │   │
│   │                                                                 │   │
│   │   + Мгновенное обновление                                       │   │
│   │   - Сложность: нужно знать что инвалидировать                   │   │
│   │   - Стоимость: часто платная операция                           │   │
│   │                                                                 │   │
│   │   PURGE /images/logo.png                                        │   │
│   │   или                                                           │   │
│   │   PURGE /images/* (wildcard)                                    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   3. Versioned URLs (Cache Busting)                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   Новая версия = новый URL = новый cache entry                  │   │
│   │                                                                 │   │
│   │   + Мгновенное обновление                                       │   │
│   │   + Не нужна инвалидация                                        │   │
│   │   - Нужна система версионирования                               │   │
│   │                                                                 │   │
│   │   v1: /js/app.abc123.js                                         │   │
│   │   v2: /js/app.def456.js  ──▶  Новый URL, старый остаётся        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   4. Soft Purge (Stale-while-revalidate)                                │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   Пометить как устаревший, но продолжать отдавать               │   │
│   │                                                                 │   │
│   │   + Пользователь не ждёт                                        │   │
│   │   + Origin обновляется в фоне                                   │   │
│   │   - Кратковременная неконсистентность                           │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Примеры инвалидации для разных CDN:**

```python
import requests
import boto3
from datetime import datetime

class CDNInvalidator:
    """Инвалидация кэша для разных CDN провайдеров"""

    # Cloudflare
    def purge_cloudflare(self, zone_id: str, urls: list):
        """Purge конкретных URLs в Cloudflare"""
        response = requests.post(
            f"https://api.cloudflare.com/client/v4/zones/{zone_id}/purge_cache",
            headers={
                "Authorization": f"Bearer {self.cf_token}",
                "Content-Type": "application/json"
            },
            json={"files": urls}
        )
        return response.json()

    def purge_cloudflare_all(self, zone_id: str):
        """Purge всего кэша (осторожно!)"""
        response = requests.post(
            f"https://api.cloudflare.com/client/v4/zones/{zone_id}/purge_cache",
            headers={
                "Authorization": f"Bearer {self.cf_token}",
                "Content-Type": "application/json"
            },
            json={"purge_everything": True}
        )
        return response.json()

    # AWS CloudFront
    def invalidate_cloudfront(self, distribution_id: str, paths: list):
        """Invalidate paths в CloudFront"""
        client = boto3.client('cloudfront')
        response = client.create_invalidation(
            DistributionId=distribution_id,
            InvalidationBatch={
                'Paths': {
                    'Quantity': len(paths),
                    'Items': paths  # ['/images/*', '/css/*']
                },
                'CallerReference': str(datetime.now().timestamp())
            }
        )
        return response['Invalidation']['Id']

    # Fastly
    def purge_fastly(self, service_id: str, surrogate_key: str):
        """Purge по Surrogate-Key в Fastly"""
        response = requests.post(
            f"https://api.fastly.com/service/{service_id}/purge/{surrogate_key}",
            headers={
                "Fastly-Key": self.fastly_key,
                "Fastly-Soft-Purge": "1"  # Soft purge
            }
        )
        return response.status_code == 200

# Использование с Surrogate Keys (рекомендуемый подход)
# В ответе сервера:
# Surrogate-Key: product-123 category-electronics homepage

# При обновлении продукта:
invalidator = CDNInvalidator()
invalidator.purge_fastly("svc123", "product-123")  # Только страницы с этим продуктом
```

### TTL стратегии

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         TTL СТРАТЕГИИ                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Тип контента              │  max-age (браузер) │ s-maxage (CDN)       │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   Версионированные ассеты   │  1 год             │ 1 год                │
│   (app.abc123.js)           │  immutable         │                      │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   Невесионированные ассеты  │  1 день            │ 1 неделя             │
│   (logo.png)                │                    │                      │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   HTML страницы             │  0 (no-cache)      │ 5-10 минут           │
│                             │                    │ + stale-while-rev    │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   API (GET, публичные)      │  0 или 1 минута    │ 1-5 минут            │
│                             │                    │                      │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   API (персональные)        │  no-store          │ no-store             │
│                             │  private           │                      │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   Плейлисты стриминга       │  2-6 секунд        │ 2-6 секунд           │
│   (live HLS)                │                    │                      │
│   ──────────────────────────┼────────────────────┼──────────────────    │
│   Видео сегменты            │  1 год             │ 1 год                │
│   (.ts, .m4s)               │  immutable         │                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Пример реализации TTL стратегии:**

```python
from enum import Enum
from dataclasses import dataclass

class ContentType(Enum):
    VERSIONED_ASSET = "versioned_asset"
    STATIC_ASSET = "static_asset"
    HTML_PAGE = "html_page"
    PUBLIC_API = "public_api"
    PRIVATE_API = "private_api"
    LIVE_STREAM = "live_stream"
    VOD_SEGMENT = "vod_segment"

@dataclass
class CachePolicy:
    max_age: int  # браузер
    s_maxage: int  # CDN
    stale_while_revalidate: int = 0
    stale_if_error: int = 0
    private: bool = False
    no_store: bool = False
    immutable: bool = False

    def to_header(self) -> str:
        if self.no_store:
            return "private, no-store" if self.private else "no-store"

        parts = []
        parts.append("private" if self.private else "public")
        parts.append(f"max-age={self.max_age}")

        if self.s_maxage != self.max_age:
            parts.append(f"s-maxage={self.s_maxage}")

        if self.stale_while_revalidate:
            parts.append(f"stale-while-revalidate={self.stale_while_revalidate}")

        if self.stale_if_error:
            parts.append(f"stale-if-error={self.stale_if_error}")

        if self.immutable:
            parts.append("immutable")

        return ", ".join(parts)

# Предопределённые политики
CACHE_POLICIES = {
    ContentType.VERSIONED_ASSET: CachePolicy(
        max_age=31536000,  # 1 год
        s_maxage=31536000,
        immutable=True
    ),
    ContentType.STATIC_ASSET: CachePolicy(
        max_age=86400,   # 1 день
        s_maxage=604800  # 1 неделя
    ),
    ContentType.HTML_PAGE: CachePolicy(
        max_age=0,
        s_maxage=300,  # 5 минут
        stale_while_revalidate=60,
        stale_if_error=86400
    ),
    ContentType.PUBLIC_API: CachePolicy(
        max_age=60,
        s_maxage=300,
        stale_while_revalidate=60
    ),
    ContentType.PRIVATE_API: CachePolicy(
        max_age=0,
        s_maxage=0,
        private=True,
        no_store=True
    ),
}

# Использование в FastAPI
from fastapi import FastAPI, Response

app = FastAPI()

def apply_cache_policy(response: Response, content_type: ContentType):
    policy = CACHE_POLICIES[content_type]
    response.headers["Cache-Control"] = policy.to_header()

@app.get("/static/{version}/{filename}")
def get_versioned_asset(version: str, filename: str, response: Response):
    apply_cache_policy(response, ContentType.VERSIONED_ASSET)
    return get_file(filename)
```

---

## Популярные CDN провайдеры

### Cloudflare

```
┌─────────────────────────────────────────────────────────────────┐
│                        CLOUDFLARE                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Особенности:                                                  │
│   • 275+ PoP в мире                                             │
│   • Бесплатный тариф (отличный для начала)                      │
│   • DNS + CDN + WAF + DDoS защита в одном                       │
│   • Workers (serverless на edge)                                │
│   • Argo Smart Routing (оптимизация маршрутов)                  │
│                                                                 │
│   Интеграция:                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  1. Добавить домен в Cloudflare                         │   │
│   │  2. Изменить NS записи у регистратора                   │   │
│   │  3. Настроить Page Rules для кэширования                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Пример Workers (edge computing):                              │
│   ```javascript                                                 │
│   addEventListener('fetch', event => {                          │
│     event.respondWith(handleRequest(event.request))             │
│   })                                                            │
│                                                                 │
│   async function handleRequest(request) {                       │
│     // A/B тест на edge                                         │
│     const bucket = Math.random() < 0.5 ? 'A' : 'B';             │
│     const url = new URL(request.url);                           │
│     url.pathname = `/${bucket}${url.pathname}`;                 │
│     return fetch(url);                                          │
│   }                                                             │
│   ```                                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### AWS CloudFront

```
┌─────────────────────────────────────────────────────────────────┐
│                      AWS CLOUDFRONT                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Особенности:                                                  │
│   • 400+ PoP (Edge Locations + Regional Edge Caches)            │
│   • Глубокая интеграция с AWS (S3, EC2, Lambda@Edge)            │
│   • Lambda@Edge для серверлесс на edge                          │
│   • Origin Shield (дополнительный уровень кэша)                 │
│   • Field Level Encryption                                      │
│                                                                 │
│   Архитектура с S3:                                             │
│   ┌────────┐     ┌──────────────┐     ┌────────┐                │
│   │ Client │────▶│  CloudFront  │────▶│   S3   │                │
│   │        │◀────│  (Edge)      │◀────│ Bucket │                │
│   └────────┘     └──────────────┘     └────────┘                │
│                                                                 │
│   Terraform пример:                                             │
│   ```hcl                                                        │
│   resource "aws_cloudfront_distribution" "cdn" {                │
│     origin {                                                    │
│       domain_name = aws_s3_bucket.static.bucket_domain_name     │
│       origin_id   = "S3-static"                                 │
│                                                                 │
│       s3_origin_config {                                        │
│         origin_access_identity = aws_cloudfront_oai.main.path   │
│       }                                                         │
│     }                                                           │
│                                                                 │
│     default_cache_behavior {                                    │
│       allowed_methods  = ["GET", "HEAD"]                        │
│       cached_methods   = ["GET", "HEAD"]                        │
│       target_origin_id = "S3-static"                            │
│                                                                 │
│       forwarded_values {                                        │
│         query_string = false                                    │
│         cookies { forward = "none" }                            │
│       }                                                         │
│                                                                 │
│       viewer_protocol_policy = "redirect-to-https"              │
│       min_ttl                = 0                                │
│       default_ttl            = 86400                            │
│       max_ttl                = 31536000                         │
│       compress               = true                             │
│     }                                                           │
│                                                                 │
│     restrictions {                                              │
│       geo_restriction { restriction_type = "none" }             │
│     }                                                           │
│                                                                 │
│     viewer_certificate {                                        │
│       acm_certificate_arn = aws_acm_certificate.cert.arn        │
│       ssl_support_method  = "sni-only"                          │
│     }                                                           │
│   }                                                             │
│   ```                                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Другие провайдеры

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      СРАВНЕНИЕ CDN ПРОВАЙДЕРОВ                          │
├──────────────┬──────────────┬──────────────┬──────────────┬─────────────┤
│              │ Cloudflare   │ CloudFront   │ Akamai       │ Fastly      │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ PoP          │ 275+         │ 400+         │ 4000+        │ 70+         │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ Бесплатный   │ Да           │ Free Tier    │ Нет          │ Нет         │
│ тариф        │ (щедрый)     │ (12 мес)     │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ Edge         │ Workers      │ Lambda@Edge  │ EdgeWorkers  │ Compute@Edge│
│ Computing    │              │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ Instant      │ Да           │ ~10 мин      │ ~5 сек       │ <150 мс     │
│ Purge        │ (~seconds)   │              │              │             │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ Лучше для    │ Веб-сайты,   │ AWS          │ Enterprise,  │ API,        │
│              │ стартапы     │ инфраструк.  │ медиа        │ динамика    │
├──────────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│ Стоимость    │ Бесплатно –  │ $0.085/GB    │ Переговоры   │ $0.12/GB    │
│              │ $200+/мес    │              │ (дорого)     │             │
└──────────────┴──────────────┴──────────────┴──────────────┴─────────────┘
```

---

## CDN в архитектуре приложения

### Типичная архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    АРХИТЕКТУРА С CDN                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────┐                                │
│                              │   Clients   │                                │
│                              │ (browsers)  │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│                              ┌──────▼──────┐                                │
│                              │     DNS     │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│              ┌──────────────────────┼──────────────────────┐                │
│              │                      │                      │                │
│              ▼                      ▼                      ▼                │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐           │
│   │ cdn.example.com │   │ api.example.com │   │ www.example.com │           │
│   │   (Static CDN)  │   │   (API CDN)     │   │   (Web CDN)     │           │
│   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘           │
│            │                     │                     │                    │
│            ▼                     ▼                     ▼                    │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐           │
│   │                 │   │                 │   │                 │           │
│   │   S3 / Object   │   │  API Gateway /  │   │   App Server    │           │
│   │    Storage      │   │  Load Balancer  │   │   (SSR/SSG)     │           │
│   │                 │   │                 │   │                 │           │
│   └─────────────────┘   └────────┬────────┘   └─────────────────┘           │
│                                  │                                          │
│                         ┌────────▼────────┐                                 │
│                         │   Microservices │                                 │
│                         │   ┌───┐ ┌───┐   │                                 │
│                         │   │svc│ │svc│   │                                 │
│                         │   └───┘ └───┘   │                                 │
│                         └────────┬────────┘                                 │
│                                  │                                          │
│                         ┌────────▼────────┐                                 │
│                         │    Database     │                                 │
│                         └─────────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Multi-CDN Strategy

Использование нескольких CDN для отказоустойчивости и оптимизации.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MULTI-CDN STRATEGY                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌─────────────┐                                 │
│                         │   Traffic   │                                 │
│                         │   Manager   │                                 │
│                         │  (DNS/LB)   │                                 │
│                         └──────┬──────┘                                 │
│                                │                                        │
│         ┌──────────────────────┼──────────────────────┐                 │
│         │                      │                      │                 │
│         ▼                      ▼                      ▼                 │
│   ┌───────────┐          ┌───────────┐          ┌───────────┐           │
│   │Cloudflare │          │CloudFront │          │  Fastly   │           │
│   │   (60%)   │          │   (30%)   │          │   (10%)   │           │
│   └─────┬─────┘          └─────┬─────┘          └─────┬─────┘           │
│         │                      │                      │                 │
│         └──────────────────────┴──────────────────────┘                 │
│                                │                                        │
│                         ┌──────▼──────┐                                 │
│                         │   Origin    │                                 │
│                         │   Server    │                                 │
│                         └─────────────┘                                 │
│                                                                         │
│   Преимущества Multi-CDN:                                               │
│   • Отказоустойчивость (failover между CDN)                             │
│   • Оптимизация по регионам (разные CDN в разных странах)               │
│   • Распределение нагрузки                                              │
│   • Переговорная позиция с провайдерами                                 │
│                                                                         │
│   Реализация (Terraform + Route53):                                     │
│   ```hcl                                                                │
│   resource "aws_route53_record" "cdn" {                                 │
│     zone_id = aws_route53_zone.main.zone_id                             │
│     name    = "cdn.example.com"                                         │
│     type    = "A"                                                       │
│                                                                         │
│     set_identifier = "cloudflare-primary"                               │
│     weighted_routing_policy { weight = 60 }                             │
│                                                                         │
│     alias {                                                             │
│       name    = "cloudflare-proxy.example.com"                          │
│       zone_id = var.cloudflare_zone_id                                  │
│     }                                                                   │
│   }                                                                     │
│   ```                                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### CDN + Application Cache

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   МНОГОУРОВНЕВОЕ КЭШИРОВАНИЕ                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Level 1: Browser Cache                      │   │
│   │   • Самый быстрый (локальный)                                   │   │
│   │   • max-age управляет                                           │   │
│   │   • Service Worker для оффлайн                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                │                                        │
│                                ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Level 2: Edge Cache (CDN)                   │   │
│   │   • ~10-50ms латентность                                        │   │
│   │   • s-maxage управляет                                          │   │
│   │   • Vary для вариантов                                          │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                │                                        │
│                                ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Level 3: Origin Shield                      │   │
│   │   • Региональный кэш перед origin                               │   │
│   │   • Защита origin от нагрузки                                   │   │
│   │   • AWS CloudFront Origin Shield                                │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                │                                        │
│                                ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Level 4: Application Cache                  │   │
│   │   • Redis/Memcached                                             │   │
│   │   • ~1-5ms латентность                                          │   │
│   │   • Кэш вычислений, DB запросов                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                │                                        │
│                                ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Level 5: Database                           │   │
│   │   • Query cache                                                 │   │
│   │   • Read replicas                                               │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Реализация многоуровневого кэширования:**

```python
from functools import lru_cache
import redis
from fastapi import FastAPI, Response, Request
from typing import Optional
import hashlib
import json

app = FastAPI()
redis_client = redis.Redis(host='localhost', port=6379, db=0)

class MultiLevelCache:
    """Многоуровневое кэширование с CDN"""

    def __init__(self):
        self.redis = redis_client
        self.local_cache = {}  # In-memory для hot data

    def get(self, key: str) -> Optional[str]:
        # Level 1: In-memory (application level)
        if key in self.local_cache:
            return self.local_cache[key]

        # Level 2: Redis (shared cache)
        value = self.redis.get(key)
        if value:
            self.local_cache[key] = value.decode()
            return value.decode()

        return None

    def set(self, key: str, value: str, ttl: int = 300):
        self.local_cache[key] = value
        self.redis.setex(key, ttl, value)

    def invalidate(self, key: str):
        self.local_cache.pop(key, None)
        self.redis.delete(key)

cache = MultiLevelCache()

@app.get("/api/products")
async def get_products(response: Response, request: Request):
    # Генерируем cache key
    cache_key = f"products:{hashlib.md5(str(request.query_params).encode()).hexdigest()}"

    # Проверяем application cache
    cached = cache.get(cache_key)
    if cached:
        # Устанавливаем CDN headers
        response.headers["Cache-Control"] = "public, max-age=60, s-maxage=300"
        response.headers["X-Cache"] = "HIT"
        return json.loads(cached)

    # Генерируем данные
    products = generate_products()

    # Кэшируем в application cache
    cache.set(cache_key, json.dumps(products), ttl=600)

    # CDN headers
    response.headers["Cache-Control"] = "public, max-age=60, s-maxage=300, stale-while-revalidate=60"
    response.headers["X-Cache"] = "MISS"
    response.headers["Surrogate-Key"] = "products all-products"  # Для Fastly

    return products
```

---

## Best Practices

### 1. Версионирование статических ассетов

```javascript
// webpack.config.js
module.exports = {
  output: {
    filename: '[name].[contenthash].js',
    chunkFilename: '[name].[contenthash].chunk.js',
    assetModuleFilename: 'assets/[name].[contenthash][ext]',
  },
};

// Результат:
// main.a1b2c3d4.js
// vendor.e5f6g7h8.chunk.js
// assets/logo.i9j0k1l2.png
```

### 2. Правильные заголовки для разного контента

```nginx
# Nginx конфигурация
server {
    # Версионированные ассеты - агрессивное кэширование
    location ~* \.[a-f0-9]{8,}\.(js|css|png|jpg|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # HTML - короткий кэш с revalidation
    location ~* \.html$ {
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # API - зависит от endpoint
    location /api/ {
        # По умолчанию не кэшируем
        add_header Cache-Control "no-store";

        # Для конкретных endpoint настраиваем в приложении
        proxy_pass http://backend;
    }
}
```

### 3. Использование Surrogate Keys для умной инвалидации

```python
from fastapi import FastAPI, Response

app = FastAPI()

@app.get("/products/{product_id}")
def get_product(product_id: int, response: Response):
    product = db.get_product(product_id)

    # Surrogate Keys для Fastly/Varnish
    response.headers["Surrogate-Key"] = f"product-{product_id} category-{product.category_id} all-products"
    response.headers["Cache-Control"] = "public, s-maxage=3600"

    return product

@app.put("/products/{product_id}")
def update_product(product_id: int, data: ProductUpdate):
    product = db.update_product(product_id, data)

    # Инвалидируем только связанные страницы
    cdn.purge_by_key(f"product-{product_id}")

    return product

@app.post("/categories/{category_id}/products")
def add_product_to_category(category_id: int, data: ProductCreate):
    product = db.create_product(category_id, data)

    # Инвалидируем категорию и общие списки
    cdn.purge_by_key(f"category-{category_id}")
    cdn.purge_by_key("all-products")

    return product
```

### 4. Мониторинг CDN

```python
# Метрики для мониторинга CDN
CDN_METRICS = {
    "cache_hit_ratio": {
        "description": "Процент запросов из кэша",
        "target": "> 95%",
        "alert": "< 80%"
    },
    "origin_latency": {
        "description": "Время ответа origin при cache miss",
        "target": "< 200ms",
        "alert": "> 500ms"
    },
    "bandwidth_saved": {
        "description": "Трафик, сэкономленный кэшированием",
        "track": "monthly"
    },
    "error_rate": {
        "description": "5xx ошибки от CDN",
        "target": "< 0.1%",
        "alert": "> 1%"
    },
    "cache_invalidation_time": {
        "description": "Время распространения purge",
        "target": "< 30s",
        "alert": "> 5m"
    }
}

# Пример дашборда (Prometheus + Grafana)
"""
# prometheus/rules/cdn.yml
groups:
  - name: cdn_alerts
    rules:
      - alert: LowCacheHitRatio
        expr: cdn_cache_hit_ratio < 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Cache hit ratio низкий: {{ $value }}"

      - alert: HighOriginLatency
        expr: cdn_origin_latency_p99 > 0.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Origin latency высокий: {{ $value }}s"
"""
```

### 5. Security Best Practices

```yaml
# Cloudflare Security Settings
security:
  # Защита origin
  origin_protection:
    - Authenticated Origin Pulls (mutual TLS)
    - IP whitelist для CDN
    - Firewall rules

  # DDoS защита
  ddos:
    - Rate limiting
    - Bot management
    - WAF rules

  # SSL/TLS
  ssl:
    mode: full_strict  # Проверять сертификат origin
    min_version: TLSv1.2
    hsts: enabled

  # Headers
  security_headers:
    - X-Content-Type-Options: nosniff
    - X-Frame-Options: DENY
    - Content-Security-Policy: "..."
```

---

## Резюме

### Когда использовать CDN

| Сценарий | Рекомендация |
|----------|--------------|
| Статические ассеты (JS, CSS, изображения) | Обязательно |
| Глобальная аудитория | Обязательно |
| Высокий трафик | Обязательно |
| Видео/аудио стриминг | Обязательно |
| API с редко меняющимися данными | Рекомендуется |
| Защита от DDoS | Рекомендуется |
| Персонализированный контент | Осторожно (Vary headers) |

### Чеклист внедрения CDN

```
□ Выбрать CDN провайдера
□ Настроить DNS (CNAME или Anycast)
□ Настроить SSL/TLS сертификаты
□ Определить cache policy для разного контента
□ Настроить Cache-Control headers на origin
□ Внедрить версионирование ассетов
□ Настроить инвалидацию кэша
□ Настроить мониторинг (hit ratio, latency)
□ Протестировать в staging
□ Постепенный rollout (canary)
□ Документировать архитектуру
```

### Ключевые метрики

- **Cache Hit Ratio**: > 95% для статики
- **Time To First Byte (TTFB)**: < 100ms с edge
- **Origin Shield Hit Ratio**: > 80%
- **Invalidation Latency**: < 30 секунд
- **Bandwidth Savings**: 60-90% от общего трафика
