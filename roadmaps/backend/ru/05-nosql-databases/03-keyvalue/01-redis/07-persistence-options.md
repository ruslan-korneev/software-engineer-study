# Персистентность в Redis

Redis — in-memory база данных, но предоставляет механизмы сохранения данных на диск для восстановления после перезапуска.

## Способы персистентности

| Способ | Описание | Потеря данных |
|--------|----------|---------------|
| RDB | Снимки (snapshots) | До последнего снимка |
| AOF | Журнал операций | Зависит от fsync |
| RDB + AOF | Гибридный подход | Минимальная |
| Без персистентности | Только RAM | Все данные |

## RDB (Redis Database Backup)

### Принцип работы

RDB создаёт **снимок (snapshot)** всех данных в определённый момент времени. Файл `dump.rdb` — компактный бинарный файл.

```
Время: ─────────────────────────────────────────────>
Данные: ████████████████████████████████████████████
Снимки:     ↓              ↓              ↓
         dump.rdb       dump.rdb       dump.rdb
            t1            t2             t3
```

### Команды

```redis
# Синхронное сохранение (блокирует Redis!)
SAVE

# Асинхронное сохранение (в фоне)
BGSAVE

# Время последнего успешного сохранения
LASTSAVE
```

**SAVE vs BGSAVE:**

| Команда | Блокировка | Использование |
|---------|------------|---------------|
| `SAVE` | Да, полная | Только при shutdown |
| `BGSAVE` | Нет (fork) | Production |

### Конфигурация

```conf
# redis.conf

# Автоматические снимки
save 900 1      # Снимок если ≥1 изменение за 900 сек (15 мин)
save 300 10     # Снимок если ≥10 изменений за 300 сек (5 мин)
save 60 10000   # Снимок если ≥10000 изменений за 60 сек (1 мин)

# Отключить RDB
save ""

# Имя файла
dbfilename dump.rdb

# Директория
dir /var/lib/redis

# Сжатие (LZF)
rdbcompression yes

# Проверка контрольной суммы
rdbchecksum yes

# Остановка записи при ошибке BGSAVE
stop-writes-on-bgsave-error yes
```

### Как работает BGSAVE

```
1. Redis вызывает fork()
2. Родительский процесс продолжает обслуживать запросы
3. Дочерний процесс записывает данные в temp файл
4. После завершения temp файл переименовывается в dump.rdb

┌─────────────────┐
│  Redis Parent   │ ─── обслуживает клиентов
└────────┬────────┘
         │ fork()
         ▼
┌─────────────────┐
│  Redis Child    │ ─── пишет dump.rdb
└─────────────────┘
```

**Copy-on-Write (COW):**
- fork() использует COW — память копируется только при изменении
- Если данные активно меняются, потребление памяти может вырасти до 2x

### Плюсы и минусы RDB

**Плюсы:**
- Компактный файл (хорош для backup)
- Быстрое восстановление больших датасетов
- Минимальное влияние на производительность (fork)
- Идеален для disaster recovery

**Минусы:**
- Потеря данных между снимками
- fork() может быть медленным при больших данных
- Потребление памяти при активной записи (COW)

## AOF (Append Only File)

### Принцип работы

AOF записывает **каждую операцию записи** в журнал. При восстановлении Redis "проигрывает" все команды.

```
┌──────────────────────────────────┐
│          appendonly.aof          │
├──────────────────────────────────┤
│ *3                               │
│ $3                               │
│ SET                              │
│ $4                               │
│ key1                             │
│ $5                               │
│ value                            │
│ *3                               │
│ $3                               │
│ SET                              │
│ ...                              │
└──────────────────────────────────┘
```

Формат — RESP (Redis Serialization Protocol), человекочитаемый.

### Конфигурация

```conf
# Включить AOF
appendonly yes

# Имя файла (Redis 7+ использует директорию)
appendfilename "appendonly.aof"
appenddirname "appendonlydir"

# Режим синхронизации
appendfsync everysec   # Рекомендуется

# Автоматическая перезапись
auto-aof-rewrite-percentage 100  # Когда размер вырос на 100%
auto-aof-rewrite-min-size 64mb   # Минимум 64MB для rewrite
```

### Режимы fsync

| Режим | Описание | Потеря данных | Производительность |
|-------|----------|---------------|-------------------|
| `always` | fsync после каждой записи | ~0 | Низкая |
| `everysec` | fsync раз в секунду | ~1 сек | Хорошая |
| `no` | fsync на усмотрение ОС | До 30 сек | Высокая |

**Рекомендация:** `everysec` — оптимальный баланс.

```conf
# Максимальная надёжность (медленно)
appendfsync always

# Оптимальный баланс (рекомендуется)
appendfsync everysec

# Максимальная скорость (рискованно)
appendfsync no
```

### AOF Rewrite

Со временем AOF растёт. Rewrite создаёт компактную версию:

```
До rewrite:              После rewrite:
SET key 1                SET key 100
SET key 2
SET key 3
...
SET key 100
```

```redis
# Запустить rewrite вручную
BGREWRITEAOF

# Статус
INFO persistence
```

**Как работает rewrite:**

```
1. Redis fork()
2. Дочерний процесс создаёт новый AOF из текущего состояния
3. Родитель записывает новые команды в буфер
4. После завершения буфер добавляется к новому AOF
5. Атомарная замена файлов
```

### Структура AOF в Redis 7+

Redis 7 использует Multi Part AOF:

```
appendonlydir/
├── appendonly.aof.1.base.rdb    # Базовый снимок (RDB формат)
├── appendonly.aof.1.incr.aof    # Инкрементальные изменения
└── appendonly.aof.manifest      # Манифест
```

### Плюсы и минусы AOF

**Плюсы:**
- Минимальная потеря данных (до 1 сек с everysec)
- Формат понятен человеку
- Можно редактировать (удалить ошибочную команду)
- Auto-rewrite предотвращает рост файла

**Минусы:**
- Файлы больше, чем RDB
- Восстановление медленнее (replay команд)
- Может быть медленнее RDB при `always`

## Гибридный подход (RDB + AOF)

### Зачем комбинировать

- **RDB** — быстрое восстановление
- **AOF** — минимальная потеря данных

Redis 7+ по умолчанию использует гибридный AOF:
- Base file в формате RDB (быстрая загрузка)
- Incremental file в формате AOF (свежие данные)

### Конфигурация

```conf
# Включить оба механизма
appendonly yes
save 900 1
save 300 10
save 60 10000

# Гибридный формат AOF (по умолчанию в Redis 7+)
aof-use-rdb-preamble yes
```

### Порядок восстановления

```
При старте Redis:
1. Если есть AOF → загрузить AOF
2. Иначе если есть RDB → загрузить RDB
3. Иначе → пустая база
```

AOF имеет приоритет, так как обычно содержит более свежие данные.

## Сравнительная таблица

| Характеристика | RDB | AOF | RDB + AOF |
|----------------|-----|-----|-----------|
| Потеря данных | Минуты | Секунды | Секунды |
| Размер файла | Маленький | Большой | Средний |
| Скорость восстановления | Быстрая | Медленная | Быстрая |
| Влияние на производительность | Низкое | Среднее | Среднее |
| Читаемость файла | Нет | Да | Частично |
| Подходит для backup | Да | Нет | Да |

## Рекомендации по выбору

### Только кэш (данные можно потерять)

```conf
# Отключить персистентность
save ""
appendonly no
```

### Максимальная производительность

```conf
# Только RDB с редкими снимками
save 900 1
appendonly no
```

### Баланс надёжности и производительности

```conf
# AOF с everysec (рекомендуется для большинства)
appendonly yes
appendfsync everysec
save ""  # RDB не нужен, AOF достаточно
```

### Максимальная надёжность

```conf
# AOF always + RDB для backup
appendonly yes
appendfsync always
save 900 1
```

### Production рекомендация

```conf
# Гибридный подход
appendonly yes
appendfsync everysec
aof-use-rdb-preamble yes

# RDB для backup (на реплике)
save 900 1
save 300 10
```

## Проверка и восстановление

### Проверка RDB

```bash
redis-check-rdb /var/lib/redis/dump.rdb
```

### Проверка и исправление AOF

```bash
# Проверка
redis-check-aof /var/lib/redis/appendonlydir/appendonly.aof.1.incr.aof

# Исправление (удалит повреждённые данные)
redis-check-aof --fix /var/lib/redis/appendonlydir/appendonly.aof.1.incr.aof
```

## Мониторинг персистентности

```redis
INFO persistence

# Ключевые метрики:
# rdb_last_save_time — время последнего RDB
# rdb_last_bgsave_status — статус последнего BGSAVE
# aof_last_rewrite_status — статус последнего rewrite
# aof_current_size — текущий размер AOF
```

## Типичные проблемы

### 1. BGSAVE fails (недостаточно памяти)

```bash
# Разрешить overcommit памяти
echo 1 > /proc/sys/vm/overcommit_memory

# Или в sysctl.conf
vm.overcommit_memory = 1
```

### 2. AOF слишком большой

```redis
# Принудительный rewrite
BGREWRITEAOF

# Проверить настройки auto-rewrite
CONFIG GET auto-aof-rewrite*
```

### 3. Медленное восстановление

- Используйте гибридный AOF (`aof-use-rdb-preamble yes`)
- Делайте rewrite регулярно
- Рассмотрите чистый RDB если потеря данных допустима
