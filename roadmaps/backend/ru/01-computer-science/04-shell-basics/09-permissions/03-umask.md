# Команда umask

[prev: 02-chmod](./02-chmod.md) | [next: 04-su-sudo](./04-su-sudo.md)

---
## Что такое umask?

**umask** (user file-creation mode mask) — маска, определяющая права по умолчанию для новых файлов и директорий. Она "вычитается" из максимальных прав.

## Как работает umask

### Максимальные права
- Файлы: 666 (rw-rw-rw-) — без x для безопасности
- Директории: 777 (rwxrwxrwx)

### Формула
```
Итоговые права = Максимальные права - umask
```

### Примеры
```
umask 022:
  Файлы:     666 - 022 = 644 (rw-r--r--)
  Директории: 777 - 022 = 755 (rwxr-xr-x)

umask 077:
  Файлы:     666 - 077 = 600 (rw-------)
  Директории: 777 - 077 = 700 (rwx------)
```

## Просмотр текущего umask

```bash
$ umask
0022

$ umask -S          # символьный формат
u=rwx,g=rx,o=rx
```

## Установка umask

### Временно (на сессию)
```bash
$ umask 027
$ touch newfile.txt
$ ls -l newfile.txt
-rw-r----- 1 user group 0 Dec 26 10:00 newfile.txt
```

### Постоянно
```bash
# В ~/.bashrc или ~/.profile
umask 022
```

## Типичные значения umask

| umask | Файлы | Директории | Использование |
|-------|-------|------------|---------------|
| 022 | 644 | 755 | По умолчанию (стандарт) |
| 027 | 640 | 750 | Более строгий |
| 077 | 600 | 700 | Только владелец |
| 002 | 664 | 775 | Совместная работа группы |
| 000 | 666 | 777 | Максимальные права (небезопасно!) |

## Практические примеры

### Проверка с разными umask
```bash
$ umask 022
$ touch file1.txt && mkdir dir1
$ ls -l
-rw-r--r-- file1.txt
drwxr-xr-x dir1

$ umask 077
$ touch file2.txt && mkdir dir2
$ ls -l
-rw------- file2.txt
drwx------ dir2
```

### Временное изменение в скрипте
```bash
#!/bin/bash
# Сохранить старый umask
OLD_UMASK=$(umask)

# Создать приватные файлы
umask 077
touch secrets.txt

# Вернуть старый umask
umask $OLD_UMASK
```

### Использование в подшелле
```bash
$ (umask 077; touch private.txt)
# umask изменён только внутри скобок
```

## Символьный синтаксис

```bash
$ umask -S
u=rwx,g=rx,o=rx

$ umask u=rwx,g=rx,o=
$ umask -S
u=rwx,g=rx,o=

$ touch test.txt
$ ls -l test.txt
-rw-r----- test.txt    # o не имеет прав
```

## Расчёт umask

### От желаемых прав к umask

Если нужны права 640 для файлов:
```
666 - 640 = 026
```

Проверка:
```bash
$ umask 026
$ touch test.txt
$ stat -c "%a" test.txt
640
```

### Таблица расчётов

| Желаемые права файлов | Желаемые права директорий | umask |
|----------------------|--------------------------|-------|
| 644 (rw-r--r--) | 755 (rwxr-xr-x) | 022 |
| 640 (rw-r-----) | 750 (rwxr-x---) | 027 |
| 600 (rw-------) | 700 (rwx------) | 077 |
| 664 (rw-rw-r--) | 775 (rwxrwxr-x) | 002 |

## umask в системе

### Системный umask
```bash
# /etc/profile или /etc/login.defs
UMASK 022
```

### Для демонов
Некоторые сервисы устанавливают свой umask:
```bash
# В systemd unit file
UMask=0027
```

## Важные нюансы

### umask не добавляет права
umask только **убирает** права из максимальных. Он не может добавить права.

### Не влияет на существующие файлы
umask действует только на **новые** файлы. Для изменения существующих используйте chmod.

### Файлы никогда не получают x
Даже при umask 000 файлы создаются без x (666, не 777). Это защита от случайного создания исполняемых файлов.

```bash
$ umask 000
$ touch test.txt
$ ls -l test.txt
-rw-rw-rw- test.txt    # 666, не 777
```

## Безопасность

### Рекомендуемые значения

```bash
# Обычный пользователь
umask 022    # или 027 для параноиков

# Совместная работа в группе
umask 002

# Для конфиденциальных данных
umask 077
```

### Проверка umask в скриптах
```bash
#!/bin/bash
# Убедиться в безопасном umask
if [ "$(umask)" != "0077" ]; then
    echo "Warning: umask is $(umask), should be 0077"
    umask 077
fi
```

## Советы

1. **022** — хороший баланс безопасности и удобства
2. **077** — для работы с секретами
3. **Проверяйте umask** перед созданием важных файлов
4. **В скриптах** явно устанавливайте нужный umask
5. **Помните**: umask не влияет на chmod

---

[prev: 02-chmod](./02-chmod.md) | [next: 04-su-sudo](./04-su-sudo.md)
