# Квантификаторы в регулярных выражениях

[prev: 04-posix-classes](./04-posix-classes.md) | [next: 01-cat-sort-uniq](../07-text-processing/01-cat-sort-uniq.md)

---
## Что такое квантификаторы?

**Квантификаторы** определяют, сколько раз может повторяться предыдущий элемент (символ, группа или класс символов).

## Базовые квантификаторы

### Звёздочка (*) - ноль или более

```bash
# Любое количество включая 0
grep 'ab*c' text.txt
# ac (0 b)
# abc (1 b)
# abbc (2 b)
# abbbc (3 b)

# .* - любые символы (включая пустую строку)
grep 'start.*end' text.txt
# startend
# start123end
# start anything here end

# Типичное использование
grep 'colou*r' text.txt    # color, colour (0 или более u)
```

### Плюс (+) - один или более

```bash
# Минимум одно вхождение (ERE)
grep -E 'ab+c' text.txt
# abc (1 b)
# abbc (2 b)
# abbbc (3 b)
# НО НЕ ac!

# BRE - нужно экранировать
grep 'ab\+c' text.txt

# Примеры
grep -E '[0-9]+' data.txt      # числа (минимум 1 цифра)
grep -E '[a-z]+' words.txt     # слова (минимум 1 буква)
```

### Вопрос (?) - ноль или один

```bash
# Опциональный элемент (ERE)
grep -E 'ab?c' text.txt
# ac (0 b)
# abc (1 b)
# НО НЕ abbc!

# BRE
grep 'ab\?c' text.txt

# Примеры
grep -E 'https?' urls.txt      # http или https
grep -E 'colou?r' text.txt     # color или colour
grep -E '-?[0-9]+' numbers.txt # числа с опциональным минусом
```

## Точные квантификаторы {n,m}

### Ровно n раз

```bash
# Точное количество
grep -E 'a{3}' text.txt        # aaa
grep -E '[0-9]{4}' text.txt    # четырёхзначные числа

# BRE
grep 'a\{3\}' text.txt
```

### От n до m раз

```bash
# Диапазон
grep -E 'a{2,4}' text.txt      # aa, aaa, aaaa
grep -E '[0-9]{1,3}' text.txt  # 1-3 цифры

# BRE
grep 'a\{2,4\}' text.txt
```

### Минимум n раз

```bash
# n или более
grep -E 'a{2,}' text.txt       # aa, aaa, aaaa, aaaaa...
grep -E '[0-9]{5,}' text.txt   # числа из 5+ цифр

# BRE
grep 'a\{2,\}' text.txt
```

### Максимум m раз

```bash
# От 0 до m
grep -E 'a{,3}' text.txt       # (пусто), a, aa, aaa
grep -E 'x{,2}' text.txt       # максимум 2 x

# BRE
grep 'a\{,3\}' text.txt
```

## Жадные vs ленивые квантификаторы

### Жадные (greedy) - по умолчанию

Захватывают максимально возможное количество символов:

```bash
# Пример проблемы с жадным .*
echo '<b>text</b> and <b>more</b>' | grep -o '<b>.*</b>'
# <b>text</b> and <b>more</b>  - захватил всё!

# .* захватывает всё до ПОСЛЕДНЕГО </b>
```

### Ленивые (lazy) - PCRE

Захватывают минимально возможное количество:

```bash
# Добавить ? после квантификатора (только PCRE)
grep -Po '<b>.*?</b>' text.html
# <b>text</b>
# <b>more</b>

# Ленивые квантификаторы:
# *?  - ноль или более (минимум)
# +?  - один или более (минимум)
# ??  - ноль или один (предпочитает ноль)
# {n,m}? - от n до m (минимум)
```

### Примеры жадных vs ленивых

```bash
# HTML теги
echo '<div>content</div>' | grep -Po '<.*>'   # жадный: <div>content</div>
echo '<div>content</div>' | grep -Po '<.*?>'  # ленивый: <div> и </div>

# Кавычки
echo '"one" "two"' | grep -Po '".*"'   # жадный: "one" "two"
echo '"one" "two"' | grep -Po '".*?"'  # ленивый: "one" и "two"
```

### Альтернатива ленивым (без PCRE)

```bash
# Вместо .*? использовать [^X]*
# [^>]* - любые символы КРОМЕ >

echo '<b>text</b>' | grep -o '<b>[^<]*</b>'
# <b>text</b>

echo '"one" "two"' | grep -o '"[^"]*"'
# "one"
# "two"
```

## Притяжательные квантификаторы (PCRE)

Захватывают максимум и НЕ отдают (нет backtracking):

```bash
# Синтаксис: добавить + после квантификатора
# *+  - ноль или более (притяжательный)
# ++  - один или более (притяжательный)
# ?+  - ноль или один (притяжательный)
# {n,m}+ - от n до m (притяжательный)

# Пример: быстрее, но может не найти
grep -P 'a++ab' text.txt  # никогда не найдёт "aab"!
# a++ захватит все a и не отдаст

# Используется для оптимизации
grep -P '"[^"]*+"' text.txt  # строки в кавычках
```

## Практические примеры

### Валидация форматов

```bash
# Телефон: +7 (999) 123-45-67
grep -E '^\+?[0-9]{1,3}[- ]?\(?[0-9]{3}\)?[- ]?[0-9]{3}[- ]?[0-9]{2}[- ]?[0-9]{2}$' phones.txt

# Email (упрощённый)
grep -E '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$' emails.txt

# IP адрес
grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$' ips.txt

# Дата YYYY-MM-DD
grep -E '^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$' dates.txt

# Время HH:MM:SS
grep -E '^([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$' times.txt
```

### Поиск в логах

```bash
# Временные метки
grep -E '[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' log.txt

# HTTP коды
grep -E ' [0-9]{3} ' access.log

# UUID
grep -E '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' data.txt
```

### Извлечение данных

```bash
# Числа
grep -Eo '[0-9]+' data.txt

# Слова длиной 5-10 символов
grep -Eo '\b[a-zA-Z]{5,10}\b' text.txt

# Цены ($XX.XX)
grep -Eo '\$[0-9]+(\.[0-9]{2})?' prices.txt

# Версии (X.Y.Z)
grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' versions.txt
```

## Оптимизация и производительность

### Проблема catastrophic backtracking

```bash
# ОПАСНО: (a+)+ может привести к экспоненциальному времени
# На строке "aaaaaaaaaaaaaaaaaaaaaaaaaab" зависнет!
echo 'aaaaaaaaaaaaaaaaaaaaaaaaaab' | grep -P '(a+)+b'

# Решение: упростить или использовать притяжательные
echo 'aaaaaaaaaaaaaaaaaaaaaaaaaab' | grep -P 'a+b'
```

### Рекомендации

```bash
# 1. Будьте конкретнее
# Плохо: .*
# Лучше: [^<]*

# 2. Используйте нежадные квантификаторы когда нужно
grep -Po '<.*?>' html.txt

# 3. Якоря ускоряют поиск
grep '^Error' log.txt      # быстрее чем grep 'Error'

# 4. Избегайте вложенных квантификаторов
# Плохо: (a*)*
# Хорошо: a*
```

## Таблица квантификаторов

| Квантификатор | Значение | Пример |
|---------------|----------|--------|
| `*` | 0 или более | `a*` = "", a, aa, aaa |
| `+` | 1 или более | `a+` = a, aa, aaa |
| `?` | 0 или 1 | `a?` = "", a |
| `{n}` | ровно n | `a{3}` = aaa |
| `{n,}` | n или более | `a{2,}` = aa, aaa, aaaa |
| `{n,m}` | от n до m | `a{2,4}` = aa, aaa, aaaa |
| `{,m}` | от 0 до m | `a{,2}` = "", a, aa |
| `*?` | 0+ (ленивый) | минимум возможного |
| `+?` | 1+ (ленивый) | минимум возможного |
| `*+` | 0+ (притяж.) | без backtracking |
| `++` | 1+ (притяж.) | без backtracking |

## Резюме

### Выбор квантификатора

| Нужно | Квантификатор |
|-------|---------------|
| Необязательный элемент | `?` |
| Повторение (вкл. 0) | `*` |
| Повторение (мин. 1) | `+` |
| Точное количество | `{n}` |
| Диапазон | `{n,m}` |
| Минимальное совпадение | `*?`, `+?` |

### BRE vs ERE

```bash
# BRE (grep) - экранировать
grep 'a\+' file.txt
grep 'a\{2,4\}' file.txt

# ERE (grep -E) - без экранирования
grep -E 'a+' file.txt
grep -E 'a{2,4}' file.txt
```

---

[prev: 04-posix-classes](./04-posix-classes.md) | [next: 01-cat-sort-uniq](../07-text-processing/01-cat-sort-uniq.md)
