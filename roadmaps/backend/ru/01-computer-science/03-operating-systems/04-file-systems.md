# Файловые системы (File Systems)

[prev: 03-memory-management](./03-memory-management.md) | [next: 05-gui-vs-cli](./05-gui-vs-cli.md)

---
## Определение

**Файловая система** — это способ организации и хранения данных на носителе (жёсткий диск, SSD, USB-накопитель), который определяет, как данные именуются, хранятся и извлекаются. Файловая система предоставляет абстракцию над физическими блоками хранения.

## Основные концепции

### Файл

**Файл** — именованная последовательность байтов, хранящаяся на постоянном носителе.

Атрибуты файла:
- **Имя** — идентификатор для пользователя
- **Тип** — определяется расширением или magic number
- **Размер** — в байтах
- **Права доступа** — чтение, запись, выполнение
- **Временные метки** — создание, модификация, доступ
- **Владелец** — пользователь и группа

### Каталог (Directory)

**Каталог** — специальный файл, содержащий список файлов и подкаталогов.

```
/                         ← Корневой каталог
├── home/
│   └── user/
│       ├── documents/
│       │   └── file.txt
│       └── .bashrc
├── etc/
│   └── nginx/
│       └── nginx.conf
└── var/
    └── log/
        └── syslog
```

### Путь к файлу

```bash
# Абсолютный путь (от корня)
/home/user/documents/file.txt

# Относительный путь (от текущего каталога)
./documents/file.txt
../other_user/file.txt
```

## Типы файловых систем

### Дисковые файловые системы

| Файловая система | ОС | Макс. размер файла | Макс. размер раздела | Особенности |
|------------------|----|--------------------|----------------------|-------------|
| **ext4** | Linux | 16 ТБ | 1 ЭБ | Журналирование, стабильность |
| **XFS** | Linux | 8 ЭБ | 8 ЭБ | Высокая производительность |
| **Btrfs** | Linux | 16 ЭБ | 16 ЭБ | Снапшоты, сжатие, RAID |
| **NTFS** | Windows | 16 ЭБ | 256 ТБ | Журналирование, ACL |
| **APFS** | macOS | 8 ЭБ | 8 ЭБ | Оптимизация для SSD |
| **FAT32** | Все | 4 ГБ | 2 ТБ | Совместимость |
| **exFAT** | Все | 16 ЭБ | 128 ПБ | USB-накопители |

### Сетевые файловые системы

- **NFS** (Network File System) — Unix/Linux
- **SMB/CIFS** — Windows (Samba в Linux)
- **GlusterFS**, **CephFS** — распределённые ФС

### Специальные файловые системы в Linux

```bash
# Виртуальные файловые системы
/proc     # Информация о процессах и ядре
/sys      # Информация об устройствах
/dev      # Файлы устройств
/run      # Данные времени выполнения
tmpfs     # Файловая система в RAM
```

## Структура файловой системы

### Структура ext4

```
┌─────────────────────────────────────────────────────────────┐
│                    Суперблок (Superblock)                   │
│  - Размер блока, количество блоков                          │
│  - Количество inode, свободных блоков                       │
│  - Флаги файловой системы                                   │
├─────────────────────────────────────────────────────────────┤
│                    Группы блоков                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Group Descriptor │ Block Bitmap │ Inode Bitmap │ Inode │ │
│ │     Table        │              │              │ Table │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │                     Data Blocks                         │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Inode (Index Node)

**Inode** — структура данных, содержащая метаданные файла (кроме имени).

```
┌──────────────────────────────────────┐
│              Inode                   │
├──────────────────────────────────────┤
│ Тип файла (обычный, каталог, ссылка) │
│ Права доступа (rwxrwxrwx)            │
│ Владелец (UID, GID)                  │
│ Размер файла                         │
│ Временные метки (atime, mtime, ctime)│
│ Количество жёстких ссылок            │
│ Указатели на блоки данных:           │
│   - Прямые (12 шт)                   │
│   - Косвенные (single, double, triple)│
└──────────────────────────────────────┘
```

```bash
# Просмотр информации об inode
ls -i file.txt        # Номер inode
stat file.txt         # Подробная информация

# Вывод stat:
#   File: file.txt
#   Size: 1024        Blocks: 8          IO Block: 4096   regular file
#   Device: 801h/2049d  Inode: 123456     Links: 1
#   Access: (0644/-rw-r--r--)  Uid: (1000/user)   Gid: (1000/user)
#   Access: 2024-01-15 10:30:00
#   Modify: 2024-01-15 10:25:00
#   Change: 2024-01-15 10:25:00
```

## Жёсткие и символические ссылки

### Жёсткая ссылка (Hard Link)

Несколько имён указывают на один inode.

```bash
# Создание жёсткой ссылки
ln original.txt hardlink.txt

# Оба файла имеют одинаковый inode
ls -i original.txt hardlink.txt
# 123456 original.txt
# 123456 hardlink.txt

# Удаление одного имени не удаляет данные
rm original.txt
cat hardlink.txt  # Данные доступны!
```

```
original.txt ──┐
               ├──→ Inode 123456 ──→ Data Blocks
hardlink.txt ──┘
```

### Символическая ссылка (Symbolic Link / Symlink)

Специальный файл, содержащий путь к другому файлу.

```bash
# Создание символической ссылки
ln -s /path/to/original.txt symlink.txt

ls -l symlink.txt
# lrwxrwxrwx 1 user user 22 Jan 15 10:30 symlink.txt -> /path/to/original.txt

# Разные inode!
ls -i original.txt symlink.txt
# 123456 original.txt
# 789012 symlink.txt
```

```
symlink.txt ──→ Inode 789012 ──→ "/path/to/original.txt"
                                        ↓
                               Inode 123456 ──→ Data Blocks
```

## Права доступа в Unix/Linux

### Модель прав доступа

```
-rwxr-xr-- 1 user group 1024 Jan 15 10:30 file.txt
│└┬┘└┬┘└┬┘
│ │  │  └─ Other (остальные): r-- (чтение)
│ │  └──── Group (группа): r-x (чтение, выполнение)
│ └─────── Owner (владелец): rwx (чтение, запись, выполнение)
└───────── Тип: - (обычный файл), d (каталог), l (ссылка)
```

### Числовое представление

```
r = 4 (100)
w = 2 (010)
x = 1 (001)

rwxr-xr-- = 754
rwx = 4+2+1 = 7
r-x = 4+0+1 = 5
r-- = 4+0+0 = 4
```

### Изменение прав

```bash
# Символьный способ
chmod u+x file.txt       # Добавить выполнение владельцу
chmod g-w file.txt       # Убрать запись у группы
chmod o=r file.txt       # Установить только чтение для остальных
chmod a+r file.txt       # Добавить чтение всем

# Числовой способ
chmod 755 file.txt       # rwxr-xr-x
chmod 644 file.txt       # rw-r--r--
chmod 600 file.txt       # rw------- (приватный файл)

# Изменение владельца
chown user:group file.txt
chown -R user:group directory/  # Рекурсивно
```

### Специальные биты

```bash
# SUID (Set User ID) — выполнение от имени владельца
chmod u+s program        # -rwsr-xr-x
# Пример: /usr/bin/passwd

# SGID (Set Group ID) — выполнение от имени группы
chmod g+s program        # -rwxr-sr-x

# Sticky Bit — удаление только владельцем
chmod +t directory/      # drwxrwxrwt
# Пример: /tmp
```

## Работа с файлами в Linux

### Основные команды

```bash
# Создание файлов и каталогов
touch file.txt           # Создать пустой файл
mkdir directory          # Создать каталог
mkdir -p path/to/dir     # Создать с родительскими каталогами

# Копирование
cp source dest           # Копировать файл
cp -r source_dir dest    # Копировать каталог рекурсивно
cp -p source dest        # Сохранить права и временные метки

# Перемещение/переименование
mv old_name new_name     # Переименовать
mv file /path/to/dest    # Переместить

# Удаление
rm file.txt              # Удалить файл
rm -r directory/         # Удалить каталог рекурсивно
rm -f file.txt           # Удалить без подтверждения
rm -rf directory/        # ОПАСНО: удалить всё без вопросов

# Просмотр содержимого
cat file.txt             # Вывести всё содержимое
less file.txt            # Постраничный просмотр
head -n 10 file.txt      # Первые 10 строк
tail -n 10 file.txt      # Последние 10 строк
tail -f /var/log/syslog  # Следить за файлом в реальном времени
```

### Поиск файлов

```bash
# find — поиск по атрибутам
find /path -name "*.txt"          # По имени
find /path -type f -size +10M     # Файлы больше 10 МБ
find /path -mtime -7              # Изменены за последние 7 дней
find /path -user root             # Принадлежащие root
find /path -perm 644              # С определёнными правами

# locate — поиск по базе данных (быстрее)
locate filename
sudo updatedb                     # Обновить базу данных

# which — поиск исполняемых файлов
which python
# /usr/bin/python
```

## Файловые дескрипторы

### Концепция

**Файловый дескриптор (FD)** — целое число, идентифицирующее открытый файл в процессе.

```
Стандартные дескрипторы:
0 — stdin  (стандартный ввод)
1 — stdout (стандартный вывод)
2 — stderr (стандартный вывод ошибок)
```

### Пример в Python

```python
import os

# Открытие файла
fd = os.open("file.txt", os.O_RDWR | os.O_CREAT)
print(f"File descriptor: {fd}")  # Обычно 3 (после 0, 1, 2)

# Запись
os.write(fd, b"Hello, World!")

# Чтение
os.lseek(fd, 0, os.SEEK_SET)  # Переместить указатель в начало
data = os.read(fd, 100)
print(data)

# Закрытие
os.close(fd)

# Через высокоуровневый интерфейс
with open("file.txt", "r") as f:
    print(f.fileno())  # Получить дескриптор
```

### Перенаправление в bash

```bash
# Перенаправление stdout
command > output.txt      # Создать/перезаписать файл
command >> output.txt     # Добавить в конец файла

# Перенаправление stderr
command 2> errors.txt     # Только ошибки
command 2>&1              # stderr в stdout

# Комбинированное перенаправление
command > output.txt 2>&1           # Всё в один файл
command &> output.txt               # То же, короче (bash)
command > stdout.txt 2> stderr.txt  # В разные файлы

# Перенаправление stdin
command < input.txt

# /dev/null — "чёрная дыра"
command > /dev/null 2>&1  # Подавить весь вывод
```

## Монтирование файловых систем

### Концепция монтирования

**Монтирование** — подключение файловой системы к определённой точке в дереве каталогов.

```bash
# Просмотр смонтированных ФС
mount
df -h
lsblk

# Монтирование
sudo mount /dev/sdb1 /mnt/usb
sudo mount -t ntfs /dev/sdc1 /mnt/windows

# Размонтирование
sudo umount /mnt/usb

# Автоматическое монтирование (/etc/fstab)
# <device>        <mount point>  <type>  <options>       <dump> <pass>
/dev/sda1         /              ext4    defaults        0      1
/dev/sda2         /home          ext4    defaults        0      2
UUID=xxxx-xxxx    /data          xfs     defaults,nofail 0      2
```

## Журналирование

### Зачем нужно журналирование

Журналирование защищает от потери данных при сбоях (отключение питания, kernel panic).

```
Без журнала:                    С журналом:
1. Начать запись                1. Записать намерение в журнал
2. Записать данные              2. Записать данные
3. Обновить метаданные          3. Обновить метаданные
   ↓ СБОЙ                       4. Отметить завершение в журнале
   Повреждение ФС!                 ↓ СБОЙ
                                   Восстановление по журналу!
```

### Режимы журналирования ext4

```bash
# data=journal  — всё журналируется (медленно, надёжно)
# data=ordered  — метаданные журналируются, данные пишутся до (по умолчанию)
# data=writeback — только метаданные (быстро, менее надёжно)

# Проверка режима
sudo tune2fs -l /dev/sda1 | grep "Default mount options"
```

## Оптимизация и обслуживание

### Проверка файловой системы

```bash
# Проверка ext4 (раздел должен быть размонтирован)
sudo fsck.ext4 /dev/sda1

# Проверка XFS
sudo xfs_repair /dev/sdb1

# Проверка при загрузке
# touch /forcefsck (создать файл в корне)
```

### Мониторинг использования

```bash
# Использование дискового пространства
df -h                    # По файловым системам
du -sh /path             # Размер каталога
du -h --max-depth=1 /    # Размер подкаталогов

# Поиск больших файлов
find / -type f -size +100M 2>/dev/null

# ncdu — интерактивный анализ
ncdu /home
```

## Best Practices

### Организация файлов

1. **Следуйте FHS** (Filesystem Hierarchy Standard) в Linux
2. **Разделяйте данные и код** — `/var/lib` для данных, `/opt` для приложений
3. **Используйте отдельные разделы** для `/home`, `/var`, `/tmp`

### Безопасность

```bash
# Правильные права для конфигураций
chmod 600 ~/.ssh/id_rsa          # Приватный ключ
chmod 644 ~/.ssh/id_rsa.pub      # Публичный ключ
chmod 700 ~/.ssh                  # Каталог SSH

# Не давайте 777!
# chmod 777 — плохая практика, уязвимость безопасности

# Используйте umask для дефолтных прав
umask 022  # Новые файлы: 644, каталоги: 755
```

### Производительность

1. **Выбирайте правильную ФС** — ext4 для общего использования, XFS для больших файлов
2. **Используйте noatime** — отключает обновление времени доступа
3. **SSD-оптимизации** — TRIM, отключение журналирования для /tmp

```bash
# /etc/fstab с оптимизациями
/dev/sda1  /  ext4  defaults,noatime,discard  0  1
```

## Заключение

Понимание файловых систем важно для:
- Организации хранения данных приложений
- Настройки прав доступа и безопасности
- Диагностики проблем с дисками
- Оптимизации производительности I/O
- Работы с логами и конфигурациями серверов

Для backend-разработчика критично понимать права доступа, работу с файловыми дескрипторами и принципы организации данных на диске.

---

[prev: 03-memory-management](./03-memory-management.md) | [next: 05-gui-vs-cli](./05-gui-vs-cli.md)
