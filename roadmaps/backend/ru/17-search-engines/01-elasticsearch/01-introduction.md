# Введение в Elasticsearch

## Что такое Elasticsearch?

Elasticsearch — это распределённый поисковый и аналитический движок с открытым исходным кодом, построенный на базе Apache Lucene. Он предназначен для горизонтально масштабируемого полнотекстового поиска, структурированного поиска и аналитики в реальном времени.

## Основные характеристики

### Ключевые особенности

- **Распределённая архитектура** — данные автоматически распределяются по нодам кластера
- **Полнотекстовый поиск** — мощные возможности поиска с поддержкой различных языков
- **Поиск в реальном времени** — документы доступны для поиска почти мгновенно после индексации
- **RESTful API** — все операции выполняются через HTTP/JSON
- **Схема-независимость** — автоматическое определение типов данных (schema-less)
- **Высокая доступность** — встроенная репликация и отказоустойчивость

### Типичные сценарии использования

```
1. Поиск по сайту или приложению
2. Логирование и анализ логов (ELK Stack)
3. Мониторинг метрик приложений
4. Аналитика бизнес-данных
5. Геопространственный поиск
6. Поиск по товарам в e-commerce
7. Автодополнение и подсказки
```

## Сравнение с реляционными базами данных

### Терминология

| SQL Database | Elasticsearch |
|-------------|---------------|
| Database    | Index (до 7.x — несколько индексов) |
| Table       | Type (устарел с 7.x, теперь один type на индекс) |
| Row         | Document |
| Column      | Field |
| Schema      | Mapping |
| SQL Query   | Query DSL (JSON) |

### Пример: SQL vs Elasticsearch

**SQL запрос:**
```sql
SELECT * FROM products
WHERE name LIKE '%laptop%'
AND price BETWEEN 500 AND 1500
ORDER BY rating DESC
LIMIT 10;
```

**Elasticsearch Query DSL:**
```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "name": "laptop" } }
      ],
      "filter": [
        { "range": { "price": { "gte": 500, "lte": 1500 } } }
      ]
    }
  },
  "sort": [
    { "rating": "desc" }
  ],
  "size": 10
}
```

### Ключевые различия

| Аспект | SQL Database | Elasticsearch |
|--------|-------------|---------------|
| **Основное назначение** | OLTP, транзакции, CRUD | Поиск и аналитика |
| **Полнотекстовый поиск** | Ограниченный (LIKE) | Нативный, мощный |
| **ACID транзакции** | Полная поддержка | Нет (eventual consistency) |
| **Нормализация** | Рекомендуется | Денормализация предпочтительна |
| **Связи (JOIN)** | Нативная поддержка | Ограниченная (nested, parent-child) |
| **Скорость поиска** | Зависит от индексов | Оптимизирован для поиска |
| **Масштабирование** | Вертикальное (часто) | Горизонтальное (нативное) |

## Когда использовать Elasticsearch

### Подходит для:

```
✅ Полнотекстовый поиск с релевантностью
✅ Поиск с автодополнением и исправлением опечаток
✅ Агрегации и аналитика больших объёмов данных
✅ Логирование и мониторинг
✅ Геопространственные запросы
✅ Поиск с фасетами (фильтрация по категориям)
✅ Real-time аналитика
```

### Не подходит для:

```
❌ Основное хранилище данных (source of truth)
❌ Транзакционные операции (банковские переводы)
❌ Частые обновления одних и тех же документов
❌ Сложные JOIN-операции между сущностями
❌ Хранение бинарных файлов
```

## Архитектурный паттерн использования

```
┌─────────────────────────────────────────────────────────┐
│                      Application                         │
└─────────────────────────────────────────────────────────┘
                    │                    │
                    ▼                    ▼
┌─────────────────────────┐    ┌─────────────────────────┐
│   Primary Database      │───▶│     Elasticsearch       │
│   (PostgreSQL, MySQL)   │    │   (Search & Analytics)  │
│                         │    │                         │
│   - Source of truth     │    │   - Full-text search    │
│   - Transactions        │    │   - Aggregations        │
│   - Complex relations   │    │   - Fast queries        │
└─────────────────────────┘    └─────────────────────────┘
         │                              ▲
         │         Sync                 │
         └──────────────────────────────┘
              (CDC, Queue, ETL)
```

## Установка и первый запуск

### Docker (рекомендуется для разработки)

```bash
# Запуск одиночного узла
docker run -d \
  --name elasticsearch \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  docker.elastic.co/elasticsearch/elasticsearch:8.11.0
```

### Docker Compose с Kibana

```yaml
version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch

volumes:
  es_data:
```

### Проверка работоспособности

```bash
# Проверка статуса кластера
curl -X GET "localhost:9200/_cluster/health?pretty"

# Информация о кластере
curl -X GET "localhost:9200/?pretty"
```

**Ответ:**
```json
{
  "name": "node-1",
  "cluster_name": "docker-cluster",
  "cluster_uuid": "abc123...",
  "version": {
    "number": "8.11.0",
    "build_type": "docker",
    "lucene_version": "9.8.0"
  },
  "tagline": "You Know, for Search"
}
```

## Экосистема Elastic Stack (ELK)

```
┌─────────────────────────────────────────────────────────┐
│                        Kibana                            │
│              (Визуализация и управление)                 │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Elasticsearch                         │
│              (Хранение, поиск, аналитика)               │
└─────────────────────────────────────────────────────────┘
                           ▲
                           │
┌─────────────────────────────────────────────────────────┐
│                       Logstash                           │
│            (Сбор, обработка, трансформация)             │
└─────────────────────────────────────────────────────────┘
                           ▲
                           │
┌─────────────────────────────────────────────────────────┐
│                        Beats                             │
│         (Легковесные агенты сбора данных)               │
│   Filebeat | Metricbeat | Packetbeat | Heartbeat        │
└─────────────────────────────────────────────────────────┘
```

## Best Practices

### При выборе Elasticsearch

1. **Определите use case** — Elasticsearch не универсальное решение
2. **Планируйте синхронизацию** — если ES не primary store, нужна стратегия синхронизации
3. **Учитывайте eventual consistency** — данные не сразу согласованы
4. **Денормализуйте данные** — в отличие от SQL, это рекомендуемый подход

### Типичные ошибки новичков

```
❌ Использовать как основную БД без резервной копии
❌ Создавать слишком много маленьких индексов
❌ Игнорировать маппинги (полагаться только на dynamic mapping)
❌ Не планировать стратегию шардирования заранее
❌ Индексировать сырые данные без нормализации формата
```

## Ресурсы для изучения

- [Официальная документация](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- [Elasticsearch: The Definitive Guide](https://www.elastic.co/guide/en/elasticsearch/guide/current/index.html) (классика, хоть и устарела частично)
- [Kibana Dev Tools](http://localhost:5601/app/dev_tools#/console) — интерактивная консоль для запросов
